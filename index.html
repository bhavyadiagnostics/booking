<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Bhavya Diagnostics</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

<style>
/* ================= CSS STYLES (SAME MODERN DESIGN) ================= */
* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
body{margin:0;font-family:-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;background:#f0f2f5;padding-bottom:120px;}

/* HEADER */
.summary{position:sticky;top:0;background:#fff;padding:12px 15px;box-shadow:0 2px 10px rgba(0,0,0,0.1);z-index:900;border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center; width: 100%; height: 60px;}
.header-left { display: flex; align-items: center; gap: 10px; }
.menu-btn { background: none; border: none; font-size: 24px; cursor: pointer; padding: 0; color: #333; line-height: 1; }
.summary-info { font-size:12px; color:#666; margin-bottom: 2px; }
.summary-total { font-size:18px; font-weight:800; color:#0a73c0; }

/* TOP PROCEED BUTTON */
.top-proceed-btn { background: #ccc; color: white; padding: 8px 15px; border-radius: 25px; font-weight: bold; font-size: 13px; border: none; cursor: not-allowed; transition: 0.3s; white-space: nowrap; flex-shrink: 0; }
.top-proceed-btn.active { background: linear-gradient(135deg, #2e7d32, #1b5e20); cursor: pointer; box-shadow: 0 4px 10px rgba(46, 125, 50, 0.3); }

/* ACTION BUTTONS */
.action-buttons { display:flex; gap:8px; padding:10px; background:#fff; position: relative; z-index: 950; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
.action-buttons button { flex:1; border:none; padding:12px 5px; border-radius:8px; color:#fff; font-size:12px; cursor:pointer; font-weight:700; letter-spacing:0.3px; white-space:nowrap; transition: 0.2s; }
.upload-rx { background:linear-gradient(45deg, #9c27b0, #673ab7); }
.view-cart { background:#333; }
.my-info-btn { background: #0a73c0; }
.my-info-btn.logged-in { background: #4caf50; }

/* PROFESSIONAL MOBILE INPUT UI */
.mobile-input-container { background: #fff; padding: 15px 20px; margin: 10px; border-radius: 16px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); border: 1px solid #fff; display: flex; align-items: center; gap: 15px; transition: 0.3s; }
.mobile-input-container:focus-within { border-color: #0a73c0; }
.mobile-icon-box { width: 40px; height: 40px; background: #e3f2fd; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 20px; }
.mobile-text-group { flex: 1; display: flex; flex-direction: column; }
.mobile-label { font-size: 11px; font-weight: 700; color: #888; text-transform: uppercase; margin-bottom: 2px; }
.mobile-real-input { border: none; background: transparent; font-size: 18px; font-weight: 800; color: #333; outline: none; width: 100%; letter-spacing: 1px; }
.plan-badge-status { font-size: 10px; padding: 3px 8px; border-radius: 6px; background: #f5f5f5; color: #999; font-weight: bold; white-space: nowrap; }
.plan-badge-status.active { background: #e8f5e9; color: #2e7d32; border: 1px solid #c8e6c9; }

/* BANNERS */
.top-banner { display: none; margin: 10px; padding: 15px; border-radius: 12px; align-items: center; justify-content: space-between; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
.tb-gold { background: linear-gradient(to right, #fff8e1, #fff); border-left: 5px solid #ffb300; }
.tb-plat { background: linear-gradient(to right, #eceff1, #fff); border-left: 5px solid #607d8b; }
.tb-title { font-weight: 800; font-size: 14px; color: #333; }
.tb-desc { font-size: 11px; color: #666; }
.tb-btn { background: #333; color: white; border: none; padding: 5px 12px; border-radius: 20px; font-size: 10px; font-weight: bold; }
.vip-badge { display:none; margin:10px; background:linear-gradient(45deg, #333, #000); color:gold; padding:15px; border-radius:12px; text-align:center; font-weight:bold; box-shadow:0 5px 15px rgba(0,0,0,0.2); }

/* SIDEBAR */
.sidebar-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 4000; display: none; backdrop-filter: blur(2px); }
.sidebar { position: fixed; top: 0; left: -280px; width: 280px; height: 100%; background: #fff; z-index: 4100; transition: 0.3s; box-shadow: 2px 0 10px rgba(0,0,0,0.1); display: flex; flex-direction: column; }
.sidebar.open { left: 0; }
.sidebar-header { background: #0a73c0; color: white; padding: 20px; font-size: 18px; font-weight: bold; }
.sidebar-menu { padding: 10px; overflow-y: auto; flex: 1; }
.menu-item { display: flex; align-items: center; gap: 15px; padding: 15px; border-bottom: 1px solid #f0f0f0; color: #333; font-size: 14px; cursor: pointer; }
.sidebar-footer { padding: 20px; font-size: 11px; color: #999; text-align: center; border-top: 1px solid #eee; }

/* NAVIGATION */
.nav-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; padding: 10px; background: #fff; margin-bottom: 10px; }
.nav-btn { padding: 10px 5px; border: 1px solid #eee; border-radius: 12px; background: #f8f9fa; font-weight: 600; cursor: pointer; font-size: 11px; color: #444; transition: 0.2s; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 55px; }
.nav-btn.active { background: #e3f2fd; color: #0a73c0; border-color: #0a73c0; transform: translateY(-1px); box-shadow: 0 4px 8px rgba(10, 115, 192, 0.2); }

/* SECTIONS & CARDS */
.section{display:none;padding:10px}
.section.active{display:block !important;}
.search{width:100%;padding:12px;border-radius:8px;border:1px solid #ddd;font-size:15px;box-sizing:border-box;outline:none;transition:0.3s; margin-bottom:15px; background: #fff url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="%23999" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>') no-repeat 95% center; }

.plan-row{display:flex;gap:10px;margin-bottom:20px;background:#fff;padding:10px;border-radius:12px;}
.plan{flex:1;background:#f8f9fa;border:2px solid transparent;border-radius:10px;padding:12px 5px;text-align:center;font-size:12px;cursor:pointer;position:relative;font-weight:600;color:#555;transition:0.2s}
.plan.active{border-color:#0a73c0;background:#e8f3ff;color:#0a73c0;}
.plan.locked { opacity: 0.4; pointer-events: none; filter: grayscale(1); position: relative; background: #eee; }
.plan.locked::after { content: "ğŸ”’"; position: absolute; top: 5px; right: 5px; font-size: 14px; }

.tag{position:absolute;top:-10px;right:-5px;background:linear-gradient(45deg, #ff9800, #ff5722);color:#fff;font-size:9px;padding:3px 8px;border-radius:10px;font-weight:bold;}
.tag.green{background:linear-gradient(45deg, #43a047, #1b5e20); color:#fff;}

.card, .pkg-card { background: #fff; border-radius: 16px; padding: 12px; margin-bottom: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); display: grid; grid-template-columns: 1fr 90px; gap: 10px; align-items: center; border: 1px solid #f0f0f0; transition: transform 0.2s; position: relative; }
.card.selected, .pkg-card.selected { border-color: #0a73c0; background: #fbfdff; transform: scale(1.01); }
.card-info, .pkg-name { font-size: 14px; font-weight: 700; color: #333; margin-bottom: 4px; line-height: 1.3; }
.mrp-price { font-size: 12px; color: #999; text-decoration: line-through; margin-right: 5px; }
.final-price, .pkg-rate { font-size: 16px; color: #2e7d32; font-weight: 800; }
.unlock-badge { font-size:10px; font-weight:bold; background:#fff8e1; color:#ff8f00; padding:2px 5px; border-radius:4px; display:inline-block; margin-bottom:5px; border:1px solid #ffb300; }
.platinum-badge { background:#eceff1; color:#455a64; border-color:#607d8b; }

.add-btn { background: linear-gradient(135deg, #0a73c0, #005b9f); color: white; border: none; padding: 8px 0; width:100%; border-radius: 25px; cursor: pointer; font-weight: bold; font-size: 13px; }
.qty-control { display: none; align-items: center; background: #e3f2fd; border-radius: 25px; padding: 2px; border: 1px solid #0a73c0; width:100%; justify-content: space-between; }
.qty-control button { background: transparent; border: none; color: #0a73c0; font-weight: bold; font-size: 18px; width: 30px; }
.doc-card { display:flex; flex-direction: row; gap: 15px; align-items: center; background:#fff; padding:10px; border-radius:12px; margin-bottom:10px; box-shadow:0 2px 5px rgba(0,0,0,0.05); }
.doc-img { width: 60px; height: 60px; border-radius: 50%; object-fit: cover; background: #eee; border: 2px solid #fff; }
.book-btn { background: #2e7d32; color: white; border: none; padding: 8px 15px; border-radius: 20px; font-weight: bold; font-size: 12px; margin-left:auto;}
.contrast-box { font-size: 11px; font-weight: bold; color: #d32f2f; margin-bottom: 5px; display: block; background: #ffebee; padding: 5px; border-radius: 5px; border: 1px dashed #d32f2f; cursor: pointer; }

/* ANIMATION KEYFRAMES */
@keyframes slideDown {Â 
Â  Â  from { transform: translateY(-100%); }Â 
Â  Â  to { transform: translateY(0); }Â 
}
@keyframes slideUp { from{transform:translateY(100%);} to{transform:translateY(0);} }

/* UPDATED TOP-DOWN MODALS */
#mainCartBox, #stepModal {Â 
Â  Â  top: 0; bottom: auto; left: 0; transform: none;Â 
Â  Â  width: 100%; max-width: 100%;Â 
Â  Â  border-radius: 0 0 25px 25px; padding: 0;Â 
Â  Â  display: none; flex-direction: column;Â 
Â  Â  height: auto; max-height: 75vh;Â 
Â  Â  animation: slideDown 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);Â 
Â  Â  z-index: 5200 !important; box-shadow: 0 5px 25px rgba(0,0,0,0.1);
}

#universalFormModal {
Â  Â  width: 100% !important; max-width: 100% !important; height: 85vh !important;
Â  Â  top: 0 !important; bottom: auto !important; left: 0 !important; transform: none !important;
Â  Â  border-radius: 0 0 25px 25px !important; padding: 0 !important;
Â  Â  display: none; flex-direction: column; z-index: 6000 !important; background: #fff;
Â  Â  animation: slideDown 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
}

#partnerModal {
Â  Â  top: 0; bottom: auto; left: 50%; transform: translateX(-50%);
Â  Â  width: 95%; max-width: 380px;
Â  Â  border-radius: 0 0 20px 20px;
Â  Â  animation: slideDown 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
}

.popup-overlay{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);z-index:5000;backdrop-filter:blur(5px)}
.popup-box{display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);width:90%; max-width:350px; background:#fff; border-radius:20px; padding:20px; z-index:5100; max-height:85vh; overflow-y:auto; box-shadow: 0 10px 30px rgba(0,0,0,0.2); box-sizing:border-box}

.form-header { padding: 15px 20px; background: #fff; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
.form-iframe { width: 100%; flex: 1; border: none; background: #fff; border-radius: 0 0 25px 25px;}

.sheet-handle { width: 40px; height: 5px; background: #e0e0e0; border-radius: 5px; margin: 15px auto 0 auto; order: 2;}
.sheet-header { padding: 15px 20px; background: #fff; border-bottom: 1px solid #f0f0f0; text-align: center; display: flex; flex-direction: column;}
.sheet-header h3 { margin: 0; color: #333; font-size: 18px; font-weight: 800; }
.sheet-body { flex-grow: 1; overflow-y: auto; padding: 20px; min-height: 200px; }
.sheet-footer { width: 100%; padding: 15px 20px; background: #fff; border-top: 1px solid #eee; }

.booking-label { font-size: 12px; font-weight: 700; color: #888; margin: 15px 0 8px 0; display: block; text-transform: uppercase; letter-spacing: 0.5px; }
.med-input { width: 100%; padding: 12px; margin-bottom: 5px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; background: #fafafa; font-size: 14px; }
.time-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-top: 5px; }
.time-slot { padding: 10px 2px; border: 1px solid #ddd; text-align: center; border-radius: 8px; cursor: pointer; font-size: 12px; font-weight: 600; color: #555; background: #fff; }
.time-slot.selected { background: #0a73c0; color: white; border-color: #0a73c0; }
.option-group { display: flex; gap: 10px; margin-bottom: 10px; }
.option-btn { flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 8px; background: #fff; color: #555; font-weight: bold; cursor: pointer; text-align: center; font-size: 13px; transition: 0.2s; }
.option-btn.selected { background: #e3f2fd; color: #0a73c0; border-color: #0a73c0; box-shadow: 0 2px 5px rgba(10,115,192,0.2); }

/* BUTTONS */
.whatsapp-btn { background: linear-gradient(45deg, #25D366, #128C7E); color: white; font-size: 15px; font-weight: bold; padding: 14px; border-radius: 30px; border: none; width: 100%; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; }
.pay-btn { background: linear-gradient(135deg, #673ab7, #512da8); color: white; font-size: 15px; font-weight: bold; padding: 14px; border-radius: 30px; border: none; width: 100%; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; margin-bottom: 8px; }
.next-btn { background: linear-gradient(135deg, #43a047, #1b5e20); color: white; padding: 15px; width: 100%; border: none; border-radius: 12px; font-size: 18px; font-weight: 800; cursor: pointer; box-shadow: 0 4px 15px rgba(27, 94, 32, 0.4); transition: 0.3s; }
.next-btn:active { transform: scale(0.98); }

.custom-alert-box { display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); width:80%; background:#fff; border-radius:15px; padding:20px; z-index:9999; text-align:center; }
.login-input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 10px; }
.login-btn { width: 100%; padding: 12px; background: #0a73c0; color: white; font-weight: bold; border: none; border-radius: 8px; cursor: pointer; }
.cart-group-header { background: #f0f2f5; padding: 8px 15px; font-size: 12px; font-weight: bold; color: #666; margin-top: 10px; border-radius: 4px; }
.cart-item-row { display: flex; justify-content: space-between; padding: 8px 15px; font-size: 13px; border-bottom: 1px solid #eee; }
.cart-details-row { padding: 5px 15px; font-size: 11px; color: #2e7d32; background: #f9f9f9; border-bottom: 1px solid #eee; font-style: italic; }
.share-btn { background: #25D366; color: white; border: none; padding: 5px 10px; border-radius: 15px; font-size: 11px; font-weight: bold; cursor: pointer; margin-left: 5px; }
.signup-section { margin-top: 20px; padding-top: 15px; border-top: 1px solid #eee; text-align: center; }
.signup-btn-large { width: 100%; padding: 12px; background: #ff9800; color: white; font-weight: bold; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; text-decoration: none; display: inline-block; box-sizing: border-box; }

.dashboard-container { display: none; padding: 10px; background: #fff; margin-bottom: 10px; border-bottom: 1px solid #eee; }
.dash-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
.dash-points { background: linear-gradient(45deg, #FFD700, #FFA500); color: white; padding: 15px; border-radius: 12px; text-align: center; font-weight: bold; flex: 1; margin-right: 10px; box-shadow: 0 4px 10px rgba(255, 165, 0, 0.3); }
.dash-details { flex: 1; display: flex; flex-direction: column; justify-content: center; font-size: 12px; color: #555; }
.dash-label { font-size: 10px; color: #999; text-transform: uppercase; letter-spacing: 0.5px; }
.dash-val { font-weight: bold; color: #333; font-size: 13px; margin-bottom: 5px; }
.highlight-plan { color: #0a73c0; background: #e3f2fd; padding: 2px 6px; border-radius: 4px; display: inline-block; }
.dash-fam-btn { padding: 6px 12px; border-radius: 20px; border: 1px solid #ddd; background: #fff; font-size: 12px; font-weight: bold; color: #555; cursor: pointer; display: inline-block; white-space: nowrap; margin-right: 5px;}
.dash-fam-btn.active { background: #0a73c0; color: white; border-color: #0a73c0; }
.dash-fam-add { color: #0a73c0; border: 1px dashed #0a73c0; }

.dash-action-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; }
.dash-pro-btn { display: flex; align-items: center; gap: 10px; padding: 12px; border-radius: 14px; border: none; cursor: pointer; transition: 0.3s; position: relative; overflow: hidden; }
.btn-reports { background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); border: 1px solid #a5d6a7; }
.btn-history { background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); border: 1px solid #90caf9; }
.dash-pro-btn .icon-circle { width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 16px; background: rgba(255,255,255,0.8); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
.dash-pro-btn .btn-text { text-align: left; }
.btn-text .main-t { display: block; font-weight: 800; font-size: 12px; color: #2c3e50; }
.btn-text .sub-t { display: block; font-size: 9px; color: #546e7a; text-transform: uppercase; letter-spacing: 0.5px; }
.dash-pro-btn:active { transform: scale(0.96); opacity: 0.8; }

.partner-link { text-align: center; padding: 20px; color: #999; font-size: 12px; margin-top: 30px; cursor: pointer; text-decoration: underline; }
.admin-row { padding: 10px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
.status-badge { padding: 3px 8px; border-radius: 4px; font-size: 10px; font-weight: bold; color: white; }
.status-pending { background: #ff9800; }

.list-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 10px; border-bottom: 1px solid #eee; background: #fff; margin-bottom: 5px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
.list-title { font-weight: 700; font-size: 13px; color: #333; line-height: 1.2; }
.list-date { font-size: 10px; color: #999; }
.action-icon { font-size: 12px; text-decoration: none; font-weight: bold; }
.icon-green { color: #2e7d32; }
</style>
</head>

<body>

<div class="sidebar-overlay" id="sidebarOverlay" onclick="closeMenu()"></div>
<div class="sidebar" id="sidebar">
Â  Â  <div class="sidebar-header"><span>Bhavya Diagnostics</span></div>
Â  Â  <div class="sidebar-menu">
Â  Â  Â  Â  <div class="menu-item" onclick="closeMenu()"><span class="menu-icon-span">ğŸ </span> Home</div>
Â  Â  Â  Â  <div class="menu-item" onclick="closeMenu(); handleMyInfoClick()"><span class="menu-icon-span">ğŸ‘¤</span> My Profile</div>
Â  Â  Â  Â  <div class="menu-item" onclick="window.open('https://www.bhavyadiagnostics.com/services-3', '_blank')"><span class="menu-icon-span">ğŸ› ï¸</span> Services</div>
Â  Â  Â  Â  <div class="menu-item" onclick="window.open('https://www.bhavyadiagnostics.com/terms-conditions', '_blank')"><span class="menu-icon-span">ğŸ“œ</span> Terms & Conditions</div>
Â  Â  Â  Â  <div class="menu-item" onclick="window.open('https://www.bhavyadiagnostics.com/privacy-policy', '_blank')"><span class="menu-icon-span">ğŸ”’</span> Privacy Policy</div>
Â  Â  Â  Â  <div class="menu-item" onclick="window.open('https://www.bhavyadiagnostics.com/contact-5', '_blank')"><span class="menu-icon-span">ğŸ“</span> Help & Contact</div>
Â  Â  Â  Â  <div class="menu-item" onclick="shareApp()"><span class="menu-icon-span">ğŸ“¢</span> Share App</div>
Â  Â  Â  Â  <div class="menu-item" onclick="openPartnerModal()"><span class="menu-icon-span">ğŸ¥</span> Partner Login</div>
Â  Â  </div>
Â  Â  <div class="sidebar-footer">Ver 1.0.0 | Bhavya Diagnostics</div>
</div>

<div class="popup-overlay" id="overlay" onclick="closeAllPopups()"></div>
<div id="customAlert" class="custom-alert-box"><div class="alert-title">Notice</div><div id="customAlertMsg" class="alert-msg"></div><button class="alert-btn" onclick="closeCustomAlert()">OK</button></div>

<div class="summary">
Â  Â  <div class="header-left">
Â  Â  Â  Â  <button class="menu-btn" onclick="openMenu()">â˜°</button>
Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  <div class="summary-info">Your Cart</div>
Â  Â  Â  Â  Â  Â  <div class="summary-total">â‚¹<span id="headerTotal">0</span> <span style="font-size:12px;color:#666;font-weight:normal">(<span id="finalCount">0</span>)</span></div>
Â  Â  Â  Â  </div>
Â  Â  </div>
Â  Â  <button class="top-proceed-btn" id="topProceedBtn" onclick="startBookingQueue()">Cart Empty</button>
</div>

<div class="action-buttons">
Â  <button class="view-cart" onclick="toggleMainCart()">ğŸ›’ Cart</button>
Â  <button class="upload-rx" onclick="sendMedRequest()">ğŸ“„ Prescription</button>
Â  <button class="my-info-btn" id="btnMyInfo" onclick="handleMyInfoClick()">ğŸ‘¤ Login</button>Â 
</div>

<div id="topBannerGold" class="top-banner tb-gold" onclick="show('package', document.querySelector('.nav-btn:nth-child(2)'))">
Â  Â  <div><div class="tb-title">ğŸŸ¡ Upgrade to Gold</div><div class="tb-desc">Get 35% OFF on Tests</div></div>
Â  Â  <button class="tb-btn">VIEW</button>
</div>
<div id="topBannerPlat" class="top-banner tb-plat" onclick="show('package', document.querySelector('.nav-btn:nth-child(2)'))">
Â  Â  <div><div class="tb-title">ğŸ”˜ Go Platinum</div><div class="tb-desc">Get 50% OFF & VIP Service</div></div>
Â  Â  <button class="tb-btn">VIEW</button>
</div>
<div id="topVipBadge" class="vip-badge">ğŸ‘‘ MEMBER</div>

<div id="dashboardSection" class="dashboard-container">
Â  Â  <div class="dash-header">
Â  Â  Â  Â  <div class="dash-points">
Â  Â  Â  Â  Â  Â  <div style="font-size:10px; opacity:0.8;">WALLET</div>
Â  Â  Â  Â  Â  Â  <div style="font-size:24px;" id="dashPoints">0</div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="dash-details">
Â  Â  Â  Â  Â  Â  <div class="dash-label">Plan</div>
Â  Â  Â  Â  Â  Â  <div class="dash-val" id="dashPlan">Basic</div>
Â  Â  Â  Â  Â  Â  <div class="dash-label">Referral Code</div>
Â  Â  Â  Â  Â  Â  <div class="dash-val">
Â  Â  Â  Â  Â  Â  Â  Â  <span id="dashRef" style="color:#e91e63">---</span>
Â  Â  Â  Â  Â  Â  Â  Â  <button class="share-btn" onclick="shareReferral()">ğŸ“¢ Share</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  </div>
Â  Â Â 
Â  Â  <div style="margin-top:10px;">
Â  Â  Â  Â  <div style="font-size:10px; font-weight:bold; color:#666; margin-bottom:5px; text-transform:uppercase;">Select Patient</div>
Â  Â  Â  Â  <div id="dashFamilyContainer" style="display:flex; gap:8px; overflow-x:auto; padding-bottom:5px;"></div>
Â  Â  </div>

Â  Â  <div class="dash-action-grid">
Â  Â  Â  Â  <button class="dash-pro-btn btn-reports" onclick="handleMyInfoClick()">
Â  Â  Â  Â  Â  Â  <div class="icon-circle">ğŸ“‚</div>
Â  Â  Â  Â  Â  Â  <div class="btn-text">
Â  Â  Â  Â  Â  Â  Â  Â  <span class="main-t">My Reports</span>
Â  Â  Â  Â  Â  Â  Â  Â  <span class="sub-t">View Lab Results</span>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </button>
Â  Â  Â  Â  <button class="dash-pro-btn btn-history" onclick="handleMyInfoClick()">
Â  Â  Â  Â  Â  Â  <div class="icon-circle">ğŸ“œ</div>
Â  Â  Â  Â  Â  Â  <div class="btn-text">
Â  Â  Â  Â  Â  Â  Â  Â  <span class="main-t">Order History</span>
Â  Â  Â  Â  Â  Â  Â  Â  <span class="sub-t">Past Bookings</span>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </button>
Â  Â  </div>
</div>

<div class="mobile-input-container">
Â  Â  <div class="mobile-icon-box">ğŸ“±</div>
Â  Â  <div class="mobile-text-group">
Â  Â  Â  Â  <div style="display:flex; justify-content:space-between; width:100%;">
Â  Â  Â  Â  Â  Â  <span class="mobile-label">Patient Mobile</span>
Â  Â  Â  Â  Â  Â  <span id="planStatus" class="plan-badge-status">Pending</span>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <input id="mobile" class="mobile-real-input" type="tel" maxlength="10" placeholder="10 Digit Number" onkeyup="applyPlanByMobile()">
Â  Â  </div>
</div>

<div class="nav-grid">
Â  Â  <button class="nav-btn active" onclick="show('test',this)">ğŸ©¸ Blood Test</button>
Â  Â  <button class="nav-btn" onclick="show('package',this)">ğŸ“¦ Packages</button>
Â  Â  <button class="nav-btn" onclick="show('medicine',this)">ğŸ’Š Medicine</button>
Â  Â  <button class="nav-btn" onclick="show('usg',this)">ğŸ–¥ï¸ USG</button>
Â  Â  <button class="nav-btn" onclick="show('xray',this)">ğŸ¦´ X-Ray</button>
Â  Â  <button class="nav-btn" onclick="show('ct',this)">ğŸ§  CT Scan</button>
Â  Â  <button class="nav-btn" onclick="show('mri',this)">ğŸ§² MRI</button>
Â  Â  <button class="nav-btn" onclick="show('ecg',this)">ğŸ’“ ECG</button>
Â  Â  <button class="nav-btn" onclick="show('echo',this)">ğŸ«€ ECHO</button>
Â  Â  <button class="nav-btn" onclick="show('doctor',this)">ğŸ‘¨â€âš•ï¸ Doctor</button>
Â  Â  <button class="nav-btn" onclick="show('hospital',this)" style="grid-column: span 2; background:#ffebee; color:#d32f2f">ğŸ¥ Hospital Admission</button>
</div>

<div id="test" class="section active">
Â  Â  <input class="search" placeholder="Search Blood Tests..." onkeyup="filter(this,'test')">
Â  Â  <div class="plan-row"><div class="plan active" data-plan="basic" onclick="manualPlan(this)">Basic<br>20%</div><div class="plan" data-plan="gold" onclick="manualPlan(this)">Gold<br>35%<div class="tag">POPULAR</div></div><div class="plan" data-plan="platinum" onclick="manualPlan(this)">Platinum<br>50%<div class="tag green">VIP</div></div></div>
Â  Â  <div id="loadingMsg" style="text-align:center;padding:20px;color:#999">Loading Tests...</div>
</div>
<div id="package" class="section">
Â  Â  <div class="plan-row"><div class="plan active" data-plan="basic" onclick="manualPlan(this)">Basic<br>10%</div><div class="plan" data-plan="gold" onclick="manualPlan(this)">Gold<br>20%<div class="tag">POPULAR</div></div><div class="plan" data-plan="platinum" onclick="manualPlan(this)">Platinum<br>30%<div class="tag green">VIP</div></div></div>
Â  Â  <div class="pkg-grid" id="pkgGrid"></div>
</div>
<div id="medicine" class="section"><div class="med-box"><span class="med-icon">ğŸ’Š</span><h3>Upload Prescription</h3><input id="medName" class="med-input" placeholder="ğŸ’Š Medicine Name"><input id="medDuration" class="med-input" placeholder="ğŸ“… Duration"><button class="confirm-btn" onclick="sendMedRequest()" style="background: linear-gradient(135deg, #43a047, #1b5e20); color:white; padding:10px; border:none; border-radius:20px; width:100%;">ğŸ“· Upload & Order</button></div></div>
<div id="usg" class="section"><input class="search" placeholder="Search USG..." onkeyup="filter(this,'usg')"><div class="plan-row"><div class="plan active" data-plan="basic" onclick="manualPlan(this)">Basic<br>5%</div><div class="plan" data-plan="gold" onclick="manualPlan(this)">Gold<br>10%<div class="tag">POPULAR</div></div><div class="plan" data-plan="platinum" onclick="manualPlan(this)">Platinum<br>20%<div class="tag green">VIP</div></div></div><div id="usgContainer"></div></div>
<div id="xray" class="section"><input class="search" placeholder="Search X-Ray..." onkeyup="filter(this,'xray')"><div class="plan-row"><div class="plan active" data-plan="basic" onclick="manualPlan(this)">Basic<br>5%</div><div class="plan" data-plan="gold" onclick="manualPlan(this)">Gold<br>10%<div class="tag">POPULAR</div></div><div class="plan" data-plan="platinum" onclick="manualPlan(this)">Platinum<br>20%<div class="tag green">VIP</div></div></div><div id="xrayContainer"></div></div>
<div id="ct" class="section"><input class="search" placeholder="Search CT Scan..." onkeyup="filter(this,'ct')"><div class="plan-row"><div class="plan active" data-plan="basic" onclick="manualPlan(this)">Basic<br>5%</div><div class="plan" data-plan="gold" onclick="manualPlan(this)">Gold<br>10%<div class="tag">POPULAR</div></div><div class="plan" data-plan="platinum" onclick="manualPlan(this)">Platinum<br>20%<div class="tag green">VIP</div></div></div><div id="ctContainer"></div></div>
<div id="mri" class="section"><input class="search" placeholder="Search MRI..." onkeyup="filter(this,'mri')"><div class="plan-row"><div class="plan active" data-plan="basic" onclick="manualPlan(this)">Basic<br>5%</div><div class="plan" data-plan="gold" onclick="manualPlan(this)">Gold<br>10%<div class="tag">POPULAR</div></div><div class="plan" data-plan="platinum" onclick="manualPlan(this)">Platinum<br>20%<div class="tag green">VIP</div></div></div><div id="mriContainer"></div></div>
<div id="ecg" class="section"><div class="plan-row"><div class="plan active" data-plan="basic" onclick="manualPlan(this)">Basic<br>5%</div><div class="plan" data-plan="gold" onclick="manualPlan(this)">Gold<br>10%<div class="tag">POPULAR</div></div><div class="plan" data-plan="platinum" onclick="manualPlan(this)">Platinum<br>20%<div class="tag green">VIP</div></div></div><div id="ecgContainer"></div></div>
<div id="echo" class="section"><div class="plan-row"><div class="plan active" data-plan="basic" onclick="manualPlan(this)">Basic<br>5%</div><div class="plan" data-plan="gold" onclick="manualPlan(this)">Gold<br>10%<div class="tag">POPULAR</div></div><div class="plan" data-plan="platinum" onclick="manualPlan(this)">Platinum<br>20%<div class="tag green">VIP</div></div></div><div id="echoContainer"></div></div>
<div id="doctor" class="section"><input class="search" placeholder="Search Doctors..." onkeyup="filterDocs(this)"><div class="plan-row"><div class="plan active" data-plan="basic" onclick="manualPlan(this)">Basic<br>5%</div><div class="plan" data-plan="gold" onclick="manualPlan(this)">Gold<br>10%<div class="tag">POPULAR</div></div><div class="plan" data-plan="platinum" onclick="manualPlan(this)">Platinum<br>20%<div class="tag green">VIP</div></div></div><div id="docContainer"></div></div>
<div id="hospital" class="section"><div style="background:#fff; padding:20px; border-radius:12px; border-left:5px solid #e91e63;"><h3 style="margin-top:0">ğŸ¥ Hospital Admission</h3><button class="confirm-btn" onclick="sendHospRequest()" style="background:#e91e63; color:white; border:none; padding:10px; border-radius:20px; width:100%;">Send Enquiry</button></div></div>

<div class="partner-link" onclick="openPartnerModal()">ğŸ¥ Partner/Lab Login (Secure Area)</div>

<div class="popup-box" id="stepModal">
Â  Â  <div class="sheet-header">
Â  Â  Â  Â  <h3 id="stepTitle" style="margin:0;color:#0a73c0">Booking</h3>
Â  Â  Â  Â  <div id="stepSubtitle" style="font-size:12px; color:#666;"></div>
Â  Â  </div>
Â  Â  <div class="sheet-body" id="dynamicFormBody"></div>
Â  Â  <div class="sheet-footer">
Â  Â  Â  Â  <button class="next-btn" onclick="nextQueueStep()">Next â”</button>
Â  Â  Â  Â  <div class="sheet-handle"></div>
Â  Â  </div>
</div>

<div class="popup-box" id="mainCartBox">
Â  Â  <div class="sheet-header">
Â  Â  Â  Â  <h3 style="margin:0;color:#0a73c0">Final Cart</h3>
Â  Â  </div>
Â  Â  <div class="sheet-body" id="finalCartItems"></div>
Â  Â  <div class="sheet-footer">
Â  Â  Â  Â  <div class="coupon-section"><input id="couponCode" style="flex:2;padding:10px;border:1px dashed #0a73c0;border-radius:8px;" placeholder="Referral Code"><button onclick="applyCoupon()" style="flex:1;background:#333;color:white;border:none;border-radius:8px;margin-left:5px;">APPLY</button></div>
Â  Â  Â  Â  <div id="couponMsg" style="font-size:11px;margin-top:5px;"></div>
Â  Â  Â  Â  <div id="redeemBox" style="background:#fff8e1;border:1px dashed #ffb300;padding:12px;border-radius:10px;margin-top:10px;display:none;justify-content:space-between;"><label style="font-weight:bold;color:#f57f17;"><input type="checkbox" id="pointCheck" onchange="togglePointUsage()"> Redeem <span id="availPoints">0</span> Points</label><div style="font-weight:bold;">- â‚¹<span id="discountVal">0</span></div></div>
Â  Â  Â  Â  <div style="display:flex; justify-content:space-between; margin:10px 0;"><span>Payable:</span> <b>â‚¹<span id="payAmount">0</span></b></div>
Â  Â  Â  Â  <button onclick="payOnline()" class="pay-btn"><span>Pay Now (UPI)</span><span>ğŸ’³</span></button>
Â  Â  Â  Â  <button onclick="bookWithPayment()" class="whatsapp-btn"><span>Book via WhatsApp</span><span>ğŸ’¬</span></button>
Â  Â  Â  Â  <button onclick="closeAllPopups()" style="width:100%; margin-top:10px; padding:10px; background:transparent; border:none; color:#666;">Close</button>
Â  Â  Â  Â  <div class="sheet-handle"></div>
Â  Â  </div>
</div>

<div class="popup-box" id="universalFormModal">
Â  Â  <div class="form-header">
Â  Â  Â  Â  <b id="formTitle" style="color:#0a73c0">Form</b>
Â  Â  Â  Â  <button onclick="closeAllPopups()" style="background:transparent;border:none;font-size:24px;color:#333;">&times;</button>
Â  Â  </div>
Â  Â  <iframe id="formFrame" class="form-iframe" src=""></iframe>
</div>

<div class="popup-box" id="partnerModal"><h3 style="margin-top:0;color:#d32f2f;text-align:center">ğŸ”’ Partner Access</h3><div id="partnerLoginForm"><input id="partnerId" class="login-input" placeholder="Partner ID"><input type="password" id="partnerPass" class="login-input" placeholder="Password"><button class="login-btn" onclick="verifyPartner()" style="background:#333">Login to Dashboard</button></div><div id="partnerDashboard" style="display:none; text-align:center;"><div style="font-size:50px;">âœ…</div><h2 style="color:#2e7d32; margin:10px 0;">Login Successful!</h2><p id="partnerWelcomeMsg" style="color:#555;"></p><div style="margin-top:20px; padding:15px; background:#f9f9f9; border-radius:10px; border:1px dashed #ccc;"><button onclick="openFormModal(PARTNER_FORM_URL, 'Partner Portal')" style="background:#0a73c0; color:white; border:none; padding:12px 25px; border-radius:25px; font-weight:bold;">ğŸš€ Open Portal</button></div><button onclick="location.reload()" style="margin-top:20px; background:transparent; border:none; color:#999; text-decoration:underline;">Logout</button></div><button id="partnerCancelBtn" onclick="closeAllPopups()" style="width:100%;padding:10px;background:transparent;border:none;color:#999;margin-top:5px">Cancel</button></div>

<div class="popup-box" id="loginModal"><h3 style="text-align:center; color:#0a73c0">Login</h3><input type="tel" id="loginMob" class="login-input" placeholder="Mobile"><input type="password" id="loginPass" class="login-input" placeholder="Password"><button class="login-btn" onclick="checkLogin()">Login</button><div class="signup-section"><button onclick="openFormModal(SIGNUP_FORM_URL, 'New Patient Registration')" class="signup-btn-large">ğŸ“ Create Account</button></div><button onclick="closeAllPopups()" style="width:100%; margin-top:10px; background:transparent; border:none;">Cancel</button></div>
<div class="popup-box" id="infoModal"><h3 style="margin-top:0; color:#0a73c0;">My Profile</h3><div id="patientDataList" style="margin-bottom:10px"></div><div class="list-header"><h4 style="margin:0; color:#333; font-size:13px;">ğŸ“‘ My Reports</h4></div><div id="reportContainer" style="max-height:120px; overflow-y:auto; border:1px solid #eee; padding:5px; border-radius:8px;"></div><div class="list-header"><h4 style="margin:0; color:#333; font-size:13px;">ğŸ”” Order History</h4></div><div id="notifyContainer" style="max-height:120px; overflow-y:auto; border:1px solid #eee; padding:5px; border-radius:8px;"></div><button onclick="logoutUser()" style="width:100%; padding:10px; background:#ffebee; color:red; border:none; margin-top:10px; border-radius:8px;">Logout</button></div>
<div class="popup-box" id="upgradeListModal"><h3 id="upgradeTitle" style="margin-top:0;color:#0a73c0;text-align:center;"></h3><div id="upgradeGrid" class="pkg-grid"></div><button onclick="closeAllPopups()" style="width:100%;padding:10px;background:#ddd;border:none;border-radius:8px;margin-top:10px">Close</button></div>
<div class="popup-box" id="detailsModal"><h3 id="detailsTitle" style="margin-top:0;color:#0a73c0;"></h3><ul id="detailsList" style="padding-left:20px;font-size:13px;color:#555;line-height:1.6"></ul><button onclick="closeAllPopups()" style="width:100%;padding:10px;background:#ddd;border:none;border-radius:8px;margin-top:10px">Close</button></div>

<script>
/* JAVASCRIPT LOGIC REMAINS EXACTLY SAME AS PROVIDED */
const RAW_SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSpcKVcbX9ZXEsSyka1rzNprfUjwlAShQLHFiPeaQETHaoYaxXXMQXT4dQ-zIu2hpn9feD-wGy_fjdW/pub?gid=0&single=true&output=csv";
const RATE_SHEET_URL = `https://api.allorigins.win/raw?url=${encodeURIComponent(RAW_SHEET_URL)}`;
const RAW_PATIENT_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSpcKVcbX9ZXEsSyka1rzNprfUjwlAShQLHFiPeaQETHaoYaxXXMQXT4dQ-zIu2hpn9feD-wGy_fjdW/pub?gid=1566470488&single=true&output=csv";
const PATIENT_SHEET_URL = `https://api.allorigins.win/raw?url=${encodeURIComponent(RAW_PATIENT_URL)}`;
const RAW_PARTNER_DB_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSpcKVcbX9ZXEsSyka1rzNprfUjwlAShQLHFiPeaQETHaoYaxXXMQXT4dQ-zIu2hpn9feD-wGy_fjdW/pub?gid=988786822&single=true&output=csv";
const PARTNER_DB_URL = `https://api.allorigins.win/raw?url=${encodeURIComponent(RAW_PARTNER_DB_URL)}`;
const RAW_HISTORY_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSpcKVcbX9ZXEsSyka1rzNprfUjwlAShQLHFiPeaQETHaoYaxXXMQXT4dQ-zIu2hpn9feD-wGy_fjdW/pub?gid=1140710592&single=true&output=csv";
const HISTORY_DATA_URL = `https://api.allorigins.win/raw?url=${encodeURIComponent(RAW_HISTORY_URL)}`;
const PARTNER_FORM_URL = "https://docs.google.com/forms/d/e/1FAIpQLScSOZbFl-dKDA4jy5cBCQav3zpMXjgtsUReIS9itHDRdHBEMg/viewform?embedded=true";
const SIGNUP_FORM_URL = "https://docs.google.com/forms/d/e/1FAIpQLSdix2-jvF-Fr7OK0S7A514oTVXjQgmgWp4CvPUm9pEg8Y_x6w/viewform?embedded=true";
const WA_NUMBER = "918397985922";Â 
const UPI_ID = "8397985922@ptsbi";Â 

let tempSelection = [], bookingQueue = [], currentQueueIndex = 0, masterBookingData = {}, currentUser = null, patientsDB = {}, partnersDB = {}, usePoints = false, activeCoupon = null, selectedPatientName = "", currentSessionAddress = "";Â 
partnersDB['8397985922'] = { pass: '8397985922', name: 'Master Partner' };
const discountMap = { basic: 0.20, gold: 0.35, platinum: 0.50, pkg_basic: 0.10, pkg_gold: 0.20, pkg_platinum: 0.30 };

const centerAddressDB = {
Â  Â  "Shree Diagnostic": "Metro Pillar No-862, Khasra no. 2444,venus plaza nehru Enclave, Rohtak Rd, Bahadurgarh, Haryana 124507",
Â  Â  "Shree": "Metro Pillar No-862, Khasra no. 2444,venus plaza nehru Enclave, Rohtak Rd, Bahadurgarh, Haryana 124507",
Â  Â  "Ved Hospital": "MWM8+9XR, Main, Jhajjar Rd, Huda Nahar, Bahadurgarh, Haryana 124507",
Â  Â  "Ved": "MWM8+9XR, Main, Jhajjar Rd, Huda Nahar, Bahadurgarh, Haryana 124507",
Â  Â  "Default": "Metro Pillar No-862, Khasra no. 2444,venus plaza nehru Enclave, Rohtak Rd, Bahadurgarh, Haryana 124507"Â 
};

window.onload = function(){ loadGoogleSheetData(); loadPatientData(); loadPartnerData(); };

async function loadGoogleSheetData() {
Â  Â  const msg = document.getElementById("loadingMsg");
Â  Â  try {
Â  Â  Â  Â  let res = await fetch(RAW_SHEET_URL);
Â  Â  Â  Â  if(!res.ok) res = await fetch(RATE_SHEET_URL);Â 
Â  Â  Â  Â  const text = await res.text();
Â  Â  Â  Â  parseProducts(text);
Â  Â  Â  Â  refreshPrices('basic');Â 
Â  Â  } catch(e) { msg.innerHTML = "Error loading tests.<br>Check connection."; msg.style.color="red"; }
}

async function loadPatientData() {
Â  Â  try {
Â  Â  Â  Â  let res = await fetch(RAW_PATIENT_URL);
Â  Â  Â  Â  if(!res.ok) res = await fetch(PATIENT_SHEET_URL);
Â  Â  Â  Â  const text = await res.text();
Â  Â  Â  Â  parsePatients(text);
Â  Â  } catch(e) {}
}

async function loadPartnerData() {
Â  Â  try {
Â  Â  Â  Â  let res = await fetch(RAW_PARTNER_DB_URL);
Â  Â  Â  Â  if(!res.ok) res = await fetch(PARTNER_DB_URL);
Â  Â  Â  Â  const text = await res.text();
Â  Â  Â  Â  parsePartners(text);
Â  Â  } catch(e) {}
}

function parsePartners(csv) {
Â  Â  const rows = csv.split('\n').slice(1);
Â  Â  rows.forEach(row => {
Â  Â  Â  Â  const cols = row.split(',').map(c=>c.replace(/"/g,'').trim());
Â  Â  Â  Â  if(cols.length >= 2) {
Â  Â  Â  Â  Â  Â  partnersDB[cols[0].toUpperCase()] = { pass: cols[1], name: cols[2] || "Partner" };
Â  Â  Â  Â  }
Â  Â  });
}

function parsePatients(csvText) {Â 
Â  Â  const rows = csvText.split('\n');Â 
Â  Â  rows.slice(1).forEach(row => {Â 
Â  Â  Â  Â  if(!row.trim()) return;
Â  Â  Â  Â  const cols = [];
Â  Â  Â  Â  let col = "";
Â  Â  Â  Â  let quotes = false;
Â  Â  Â  Â  for(let i=0; i<row.length; i++){
Â  Â  Â  Â  Â  Â  if(row[i] === '"') { quotes = !quotes; continue; }
Â  Â  Â  Â  Â  Â  if(row[i] === ',' && !quotes) { cols.push(col.trim()); col = ""; }
Â  Â  Â  Â  Â  Â  else { col += row[i]; }
Â  Â  Â  Â  }
Â  Â  Â  Â  cols.push(col.trim());
Â  Â  Â  Â  if(cols.length < 3) return;Â 
Â  Â  Â  Â  const mob = cols[2];Â 
Â  Â  Â  Â  if(mob && mob.length >= 10) {Â 
Â  Â  Â  Â  Â  Â  let plan = cols[5] && cols[5].length > 2 ? cols[5] : 'Basic';Â 
Â  Â  Â  Â  Â  Â  let points = parseInt(cols[6]) || 0;Â 
Â  Â  Â  Â  Â  Â  let familyMembers = [];
Â  Â  Â  Â  Â  Â  if(cols[7] && cols[7].trim()) familyMembers.push(cols[7].trim());
Â  Â  Â  Â  Â  Â  if(cols[8] && cols[8].trim()) familyMembers.push(cols[8].trim());
Â  Â  Â  Â  Â  Â  if(cols[9] && cols[9].trim()) familyMembers.push(cols[9].trim());
Â  Â  Â  Â  Â  Â  patientsDB[mob] = { mobile: mob, name: cols[1], password: cols[3], address: cols[4]||"", plan: plan, points: points, reports: [], referral: cols[1].split(" ")[0].toUpperCase()+mob.slice(-3), family: familyMembers };Â 
Â  Â  Â  Â  }Â 
Â  Â  });Â 
}

function parseProducts(csvText) {Â 
Â  Â  const rows = [];
Â  Â  let currentRow = "";
Â  Â  let insideQuotes = false;
Â  Â  for (let i = 0; i < csvText.length; i++) {
Â  Â  Â  Â  const char = csvText[i];
Â  Â  Â  Â  if (char === '"') insideQuotes = !insideQuotes;
Â  Â  Â  Â  if (char === '\n' && !insideQuotes) { rows.push(currentRow); currentRow = ""; } else { currentRow += char; }
Â  Â  }
Â  Â  if (currentRow) rows.push(currentRow);
Â  Â  rows.slice(1).forEach(row => {Â 
Â  Â  Â  Â  if(!row.trim()) return;
Â  Â  Â  Â  const cols = [];
Â  Â  Â  Â  let col = "";
Â  Â  Â  Â  let quotes = false;
Â  Â  Â  Â  for(let i=0; i<row.length; i++){
Â  Â  Â  Â  Â  Â  if(row[i] === '"') { quotes = !quotes; continue; }
Â  Â  Â  Â  Â  Â  if(row[i] === ',' && !quotes) { cols.push(col.trim()); col = ""; }
Â  Â  Â  Â  Â  Â  else { col += row[i]; }
Â  Â  Â  Â  }
Â  Â  Â  Â  cols.push(col.trim());
Â  Â  Â  Â  if(cols.length < 3) return;Â 
Â  Â  Â  Â  let cat = cols[2].toLowerCase();
Â  Â  Â  Â  if(cat.includes('blood') || cat.includes('test') || cat.includes('pathology') || cat.includes('lab')) cat = 'test';
Â  Â  Â  Â  else if(cat.includes('sound') || cat.includes('usg')) cat = 'usg';
Â  Â  Â  Â  else if(cat.includes('x-ray') || cat.includes('x ray') || cat.includes('xray')) cat = 'xray';
Â  Â  Â  Â  else if(cat.includes('ct scan') || cat === 'scan' || cat === 'ct') cat = 'ct';
Â  Â  Â  Â  else if(cat.includes('mri')) cat = 'mri';
Â  Â  Â  Â  else if(cat.includes('doctor') || cat.includes('dr')) cat = 'doctor';
Â  Â  Â  Â  else if(cat.includes('package') || cat.includes('checkup')) cat = 'package';
Â  Â  Â  Â  else if(cat.includes('ecg')) cat = 'ecg';
Â  Â  Â  Â  else if(cat.includes('echo')) cat = 'echo';
Â  Â  Â  Â  let cleanPrice = cols[1].replace(/[^0-9]/g, '');
Â  Â  Â  Â  createCard({ name: cols[0].replace(/"/g, ''), price: parseInt(cleanPrice) || 0, category: cat, discount: cols[3] && cols[3].toLowerCase() === 'yes', image: cols[4]||"", details: cols[5]||"" });Â 
Â  Â  });Â 
Â  Â  if(document.querySelectorAll('.card, .doc-card, .pkg-card').length > 0) { document.getElementById("loadingMsg").style.display = 'none'; }
}

function openMenu() { document.getElementById("sidebar").classList.add("open"); document.getElementById("sidebarOverlay").style.display = "block"; }
function closeMenu() { document.getElementById("sidebar").classList.remove("open"); document.getElementById("sidebarOverlay").style.display = "none"; }
function shareApp() { const msg = `Book Blood Tests & Doctors on Bhavya Diagnostics App! Link: https://dharmender.github.io/diagnostic-app`; window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`, "_blank"); }

function show(id, btn){Â 
Â  Â  document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));Â 
Â  Â  document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));Â 
Â  Â  document.getElementById(id).classList.add('active');Â 
Â  Â  if(btn) btn.classList.add('active');Â 
}

function startBookingQueue() {
Â  Â  if(tempSelection.length === 0) return;
Â  Â  currentSessionAddress = currentUser ? currentUser.address : "";Â 
Â  Â  const categories = [...new Set(tempSelection.map(item => item.type))];
Â  Â  bookingQueue = [];
Â  Â  if(categories.includes('test')) bookingQueue.push('test');
Â  Â  if(categories.includes('package')) bookingQueue.push('package');
Â  Â  const centerServices = ['usg', 'xray', 'ct', 'mri', 'ecg', 'echo', 'doctor'];
Â  Â  centerServices.forEach(s => { if(categories.includes(s)) bookingQueue.push(s); });
Â  Â  currentQueueIndex = 0; masterBookingData = {}; renderQueueStep();
}

function renderQueueStep() {
Â  Â  const type = bookingQueue[currentQueueIndex];
Â  Â  if(!type) { closeAllPopups(); toggleMainCart(); return; }
Â  Â  document.getElementById("overlay").style.display = "block";
Â  Â  const modal = document.getElementById("stepModal");
Â  Â  modal.style.display = "flex";
Â  Â  document.getElementById("stepTitle").innerText = { 'test': 'ğŸ©¸ Blood Test', 'package': 'ğŸ“¦ Package', 'usg': 'ğŸ–¥ï¸ USG', 'xray': 'ğŸ¦´ X-Ray', 'ct': 'ğŸ§  CT Scan', 'ecg': 'ğŸ’“ ECG', 'echo': 'ğŸ«€ ECHO', 'doctor': 'ğŸ‘¨â€âš•ï¸ Doctor' }[type] || 'Booking Details';
Â  Â  document.getElementById("stepSubtitle").innerText = `Step ${currentQueueIndex + 1} of ${bookingQueue.length}`;
Â  Â  const prefillName = selectedPatientName || (currentUser ? currentUser.name : "");
Â  Â  const today = new Date().getDay();Â 
Â  Â  let timeHtml = "";
Â  Â  if(type === 'ecg') {
Â  Â  Â  Â  for(let i=0; i<24; i++) {
Â  Â  Â  Â  Â  Â  let hr = i > 12 ? i - 12 : (i===0 ? 12 : i);
Â  Â  Â  Â  Â  Â  let ampm = i >= 12 ? "PM" : "AM";
Â  Â  Â  Â  Â  Â  timeHtml += `<div class="time-slot" onclick="selectTime(this)">${hr}:00 ${ampm}</div>`;
Â  Â  Â  Â  }
Â  Â  } else {
Â  Â  Â  Â  let start = 7, end = 20;Â 
Â  Â  Â  Â  if(['usg','xray','ct','mri','echo'].includes(type)) { start = 9; end = (today === 0) ? 14 : 18; }
Â  Â  Â  Â  for(let i=start; i<=end; i++) {
Â  Â  Â  Â  Â  Â  let hr = i > 12 ? i - 12 : i; let ampm = i >= 12 ? "PM" : "AM";
Â  Â  Â  Â  Â  Â  timeHtml += `<div class="time-slot" onclick="selectTime(this)">${hr}:00 ${ampm}</div>`;
Â  Â  Â  Â  }
Â  Â  }
Â  Â  let html = '', patientInputHtml = '';
Â  Â  if(currentUser) {
Â  Â  Â  Â  patientInputHtml = `<select id="qName" class="med-input" style="font-weight:bold; background:#e3f2fd; color:#0a73c0; border:1px solid #0a73c0;">`;
Â  Â  Â  Â  patientInputHtml += `<option value="${currentUser.name}">ğŸ‘¤ ${currentUser.name} (Self)</option>`;
Â  Â  Â  Â  if(currentUser.family && currentUser.family.length > 0) { currentUser.family.forEach(f => { if(f) patientInputHtml += `<option value="${f}">ğŸ‘¥ ${f}</option>`; }); }
Â  Â  Â  Â  patientInputHtml += `</select>`;
Â  Â  } else { patientInputHtml = `<input id="qName" class="med-input" placeholder="Patient Name" value="${prefillName}">`; }

Â  Â  if(type === 'test' || type === 'package') {
Â  Â  Â  Â  html += `<span class="booking-label">Select Lab</span><div class="option-group"><div class="option-btn selected" onclick="selectOpt(this,'lab','Wellness')">Wellness</div><div class="option-btn" onclick="selectOpt(this,'lab','CRL')">CRL</div><div class="option-btn" onclick="selectOpt(this,'lab','Accuprobe')">Accuprobe</div></div><span class="booking-label">Location</span><div class="option-group"><div class="option-btn selected" onclick="toggleAddress(true); selectOpt(this,'mode','Home')">Home</div><div class="option-btn" onclick="toggleAddress(false); selectOpt(this,'mode','Center')">Center</div></div>`;
Â  Â  } else if (['usg', 'xray', 'ct', 'mri', 'echo'].includes(type)) {
Â  Â  Â  Â  html += `<span class="booking-label">Center</span><div class="option-group"><div class="option-btn selected" onclick="selectOpt(this,'center','Shree Diagnostic')"><div style="font-size:8px; color:#d32f2f; font-weight:bold; letter-spacing:0.5px;">NABH ACCREDITED</div>Shree Diagnostic</div></div>`;
Â  Â  } else if (type === 'ecg') {
Â  Â  Â  Â  html += `<span class="booking-label">Select Center</span><div class="option-group"><div class="option-btn selected" onclick="selectOpt(this,'center','Shree Diagnostic')"><div style="font-size:8px; color:#d32f2f; font-weight:bold; letter-spacing:0.5px;">NABH ACCREDITED</div>Shree Diagnostic</div><div class="option-btn" onclick="selectOpt(this,'center','Ved Hospital')">Ved Hospital</div></div>`;
Â  Â  }
Â  Â  html += `<span class="booking-label">Patient</span>${patientInputHtml}<div id="qAddressBox"><span class="booking-label">Address</span><select id="qCity" class="med-input"><option selected>Bahadurgarh</option><option>Jhajjar</option><option>Rohtak</option></select><textarea id="qAddr" class="med-input" rows="2" placeholder="Address">${currentSessionAddress}</textarea></div><span class="booking-label">Time</span><input type="date" id="qDate" class="med-input" value="${new Date().toISOString().split('T')[0]}"><div class="time-grid" id="qTimeSlots">${timeHtml}</div>`;
Â  Â  document.getElementById("dynamicFormBody").innerHTML = html;
Â  Â  document.getElementById("stepModal").dataset.currentType = type;
}

function nextQueueStep() {
Â  Â  const type = document.getElementById("stepModal").dataset.currentType;
Â  Â  const name = document.getElementById("qName").value;
Â  Â  const date = document.getElementById("qDate").value;
Â  Â  const timeEl = document.querySelector(".time-slot.selected");
Â  Â  if(!name || !date || !timeEl) { showAlert("Fill Name & Time"); return; }
Â  Â  const addrInput = document.getElementById("qAddr"); if(addrInput && addrInput.value) { currentSessionAddress = addrInput.value; }
Â  Â  let details = { name, date, time: timeEl.innerText, city: document.getElementById("qCity")?.value || "N/A", address: currentSessionAddress || "N/A" };
Â  Â  if(type === 'test' || type === 'package') { details.lab = document.querySelector(".option-btn[onclick*='lab'].selected")?.innerText || "Wellness"; details.mode = document.querySelector(".option-btn[onclick*='mode'].selected")?.innerText || "Home"; }
Â  Â  else if (['usg', 'xray', 'ct', 'mri', 'echo', 'ecg'].includes(type)) { details.center = document.querySelector(".option-btn[onclick*='center'].selected")?.innerText.replace("NABH ACCREDITED", "").trim() || "Shree Diagnostic"; details.mode = "Center"; }
Â  Â  masterBookingData[type] = details; currentQueueIndex++; renderQueueStep();
}

function toggleMainCart() {
Â  Â  document.getElementById("overlay").style.display="block";Â 
Â  Â  document.getElementById("mainCartBox").style.display="flex";
Â  Â  let html = "", grandTotal = 0, discountableTotal = 0;
Â  Â  const currentPlan = document.querySelector('.plan.active') ? document.querySelector('.plan.active').dataset.plan : 'basic';
Â  Â  const testDisc = discountMap[currentPlan];
Â  Â  const centerDisc = (currentPlan === 'platinum') ? 0.20 : (currentPlan === 'gold' ? 0.10 : 0.05);
Â  Â  [...new Set(tempSelection.map(item => item.type))].forEach(cat => {
Â  Â  Â  Â  const items = tempSelection.filter(i => i.type === cat); const booking = masterBookingData[cat];
Â  Â  Â  Â  if(items.length > 0) {
Â  Â  Â  Â  Â  Â  html += `<div class="cart-group-header">${cat.toUpperCase()} ${booking ? `(${booking.mode||booking.center||booking.lab})` : ''}</div>`;
Â  Â  Â  Â  Â  Â  items.forEach(i => {
Â  Â  Â  Â  Â  Â  Â  Â  let discount = (cat==='test' || cat==='package') ? testDisc : centerDisc;
Â  Â  Â  Â  Â  Â  Â  Â  if(cat==='package') discount = discountMap['pkg_'+currentPlan];
Â  Â  Â  Â  Â  Â  Â  Â  let finalPrice = Math.round(i.price - (i.price * discount));
Â  Â  Â  Â  Â  Â  Â  Â  let total = finalPrice * i.qty; grandTotal += total; if(cat === 'test' || cat === 'package') { discountableTotal += total; }
Â  Â  Â  Â  Â  Â  Â  Â  html += `<div class="cart-item-row"><span>${i.name} x${i.qty}</span><span><s style="font-size:10px;color:#999;margin-right:5px">â‚¹${i.price*i.qty}</s> <b>â‚¹${total}</b></span></div>`;
Â  Â  Â  Â  Â  Â  Â  Â  if(i.contrast) { let cp = 3000 * i.qty; grandTotal += cp; html += `<div class="cart-item-row" style="color:#d32f2f; font-size:11px;"><span>+ Contrast</span><span>â‚¹${cp}</span></div>`; }
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  if(booking) {
Â  Â  Â  Â  Â  Â  Â  Â  let displayAddr = ""; if ((cat === 'test' || cat === 'package')) { displayAddr = booking.mode === 'Home' ? `${booking.address}, ${booking.city}` : centerAddressDB["Ved"]; }
Â  Â  Â  Â  Â  Â  Â  Â  else { displayAddr = centerAddressDB[booking.center] || centerAddressDB["Default"]; }
Â  Â  Â  Â  Â  Â  Â  Â  html += `<div class="cart-details-row">ğŸ‘¤ ${booking.name} | ğŸ“… ${booking.date}, ${booking.time}</div>`;
Â  Â  Â  Â  Â  Â  Â  Â  html += `<div class="cart-details-row" style="color:#666;">ğŸ“ ${displayAddr}</div>`;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  });
Â  Â  let totalDiscount = 0;
Â  Â  if(activeCoupon && discountableTotal > 50) { totalDiscount += 50; document.getElementById("couponMsg").innerText = `Referral Applied (${activeCoupon}): â‚¹50 OFF`; document.getElementById("couponMsg").style.color = "green"; }
Â  Â  else if (!activeCoupon) { document.getElementById("couponMsg").innerText = ""; }
Â  Â  if(currentUser && usePoints) { let pointValue = Math.floor(currentUser.points / 10); let maxPointDiscount = Math.min(pointValue, (discountableTotal - totalDiscount)); totalDiscount += maxPointDiscount; document.getElementById("discountVal").innerText = totalDiscount; document.getElementById("availPoints").innerText = currentUser.points; }
Â  Â  else { document.getElementById("discountVal").innerText = totalDiscount; }
Â  Â  document.getElementById("finalCartItems").innerHTML = html;
Â  Â  let finalPay = grandTotal - totalDiscount; document.getElementById("payAmount").innerText = finalPay > 0 ? finalPay : 0;
Â  Â  document.getElementById("redeemBox").style.display = (currentUser && currentUser.points >= 10) ? "flex" : "none";
}

function updateQty(btn, change) {Â 
Â  Â  const m = document.getElementById("mobile").value;Â 
Â  Â  if(m.length!==10){ showAlert("Enter Mobile"); return; }Â 
Â  Â  const card = btn.closest('.card') || btn.closest('.pkg-card');Â 
Â  Â  const name = card.dataset.name; const type = card.dataset.type; const price = parseInt(card.dataset.price);Â 
Â  Â  const contrastChk = card.querySelector('.contrast-box input'); const hasContrast = contrastChk ? contrastChk.checked : false;
Â  Â  let item = tempSelection.find(i => i.name === name);Â 
Â  Â  if(item) { item.qty += change; if(change > 0 && hasContrast) item.contrast = true; if(item.qty <= 0) tempSelection = tempSelection.filter(i => i.name !== name); }Â 
Â  Â  else if(change > 0) { tempSelection.push({ name, price, type, qty: 1, contrast: hasContrast }); }Â 
Â  Â  const w = card.querySelector('.qty-wrapper');Â 
Â  Â  if(change > 0 || (item && item.qty > 0)) { w.querySelector('.add-btn').style.display = 'none'; w.querySelector('.qty-control').style.display = 'flex'; w.querySelector('span').innerText = item ? item.qty : 1; card.classList.add('selected'); }Â 
Â  Â  else { w.querySelector('.add-btn').style.display = 'block'; w.querySelector('.qty-control').style.display = 'none'; card.classList.remove('selected'); if(contrastChk) contrastChk.checked = false; }Â 
Â  Â  let count = tempSelection.reduce((s,i) => s + i.qty, 0); document.getElementById("finalCount").innerText = count;Â 
Â  Â  const tBtn = document.getElementById("topProceedBtn");Â 
Â  Â  if(count > 0) { tBtn.innerText = `Proceed (${count}) â”`; tBtn.classList.add("active"); tBtn.disabled = false; }Â 
Â  Â  else { tBtn.innerText = "Cart Empty"; tBtn.classList.remove("active"); tBtn.disabled = true; }Â 
}

function handleMyInfoClick(){ if(currentUser){ document.getElementById("overlay").style.display="block"; document.getElementById("infoModal").style.display="block"; } else { document.getElementById("overlay").style.display="block"; document.getElementById("loginModal").style.display="block"; } }

function checkLogin() {Â 
Â  Â  const u = patientsDB[document.getElementById("loginMob").value];Â 
Â  Â  if(u && u.password === document.getElementById("loginPass").value) {Â 
Â  Â  Â  Â  currentUser=u; document.getElementById("btnMyInfo").innerText="ğŸ‘¤ "+u.name.split(" ")[0]; document.getElementById("btnMyInfo").classList.add("logged-in");Â 
Â  Â  Â  Â  document.getElementById("dashPoints").innerText = u.points; document.getElementById("dashPlan").innerText = u.plan; document.getElementById("dashRef").innerText = u.referral; document.getElementById("dashPlan").className = "dash-val highlight-plan"; document.getElementById("dashboardSection").style.display = "block"; document.getElementById("availPoints").innerText = u.points;
Â  Â  Â  Â  const mobInput = document.getElementById("mobile"); mobInput.value = u.mobile; selectedPatientName = u.name;
Â  Â  Â  Â  const famCon = document.getElementById("dashFamilyContainer"); let html = `<div class="dash-fam-btn active" onclick="selectedPatientName='${u.name}'">${u.name.split(" ")[0]}</div>`;
Â  Â  Â  Â  if(u.family && u.family.length > 0) { u.family.forEach(f => { if(f) html += `<div class="dash-fam-btn" onclick="selectedPatientName='${f}'">${f}</div>`; }); }
Â  Â  Â  Â  html += `<div class="dash-fam-btn dash-fam-add" onclick="openFormModal(SIGNUP_FORM_URL, 'Add Member')">+ Add</div>`; famCon.innerHTML = html;
Â  Â  Â  Â  const p = u.plan ? u.plan.toLowerCase() : 'basic'; const bG = document.getElementById("topBannerGold"), bP = document.getElementById("topBannerPlat"), vB = document.getElementById("topVipBadge"); bG.style.display="flex"; bP.style.display="flex"; vB.style.display="none";Â 
Â  Â  Â  Â  if(p==='gold'){ bG.style.display="none"; vB.style.display="block"; vB.innerText = "ğŸ‘‘ YOU ARE A GOLD MEMBER"; }Â 
Â  Â  Â  Â  else if(p==='platinum'){ bG.style.display="none"; bP.style.display="none"; vB.style.display="block"; vB.innerText = "ğŸ‘‘ YOU ARE A PLATINUM MEMBER"; }
Â  Â  Â  Â  fetchHistory(u.mobile); closeAllPopups(); applyPlanByMobile();Â 
Â  Â  } else showAlert("Invalid Credentials");Â 
}

function applyPlanByMobile() {
Â  Â  const m = document.getElementById("mobile").value; const status = document.getElementById("planStatus");
Â  Â  if (m.length === 10) {
Â  Â  Â  Â  if (patientsDB[m]) {
Â  Â  Â  Â  Â  Â  let plan = patientsDB[m].plan.toLowerCase(); status.innerText = "âœ… " + plan.toUpperCase() + " APPLIED"; status.className = "plan-badge-status active"; refreshPrices(plan);
Â  Â  Â  Â  Â  Â  document.querySelectorAll('.plan').forEach(p => { if (p.dataset.plan !== plan) p.classList.add('locked'); else p.classList.remove('locked'); });
Â  Â  Â  Â  } else { status.innerText = "ğŸ‘¤ New User (Basic)"; status.className = "plan-badge-status"; refreshPrices('basic'); document.querySelectorAll('.plan').forEach(p => p.classList.remove('locked')); }
Â  Â  } else { status.innerText = "Pending"; status.className = "plan-badge-status"; }
}

function createCard(item) {Â 
Â  Â  if (item.category === 'doctor') { const div = document.createElement('div'); div.className = 'doc-card'; div.dataset.price = item.price; div.dataset.type = 'doctor'; div.innerHTML = `<img src="${item.image || 'https://via.placeholder.com/60'}" class="doc-img"><div class="doc-info"><div class="doc-name">${item.name}</div><div class="doc-deg">${item.details}</div><div class="doc-fee">â‚¹<span class="final-price"><b>${item.price}</b></span></div></div><button class="book-btn" onclick="bookDoctor('${item.name}', ${item.price}, this)">Book</button>`; document.getElementById("docContainer").appendChild(div); return; }Â 
Â  Â  if (item.category === 'package') { const div = document.createElement('div'); div.className = 'pkg-card'; div.dataset.name = item.name; div.dataset.price = item.price; div.dataset.type = 'package'; let badge = ""; if(item.details.toLowerCase().includes("gold")) badge = `<div class="unlock-badge">ğŸ† UNLOCKS GOLD</div>`; if(item.details.toLowerCase().includes("platinum")) badge = `<div class="unlock-badge platinum-badge">ğŸ’ UNLOCKS PLATINUM</div>`; div.innerHTML = `${badge}<div class="pkg-header"><div class="pkg-name">${item.name}</div></div><div class="pkg-body"><span class="mrp-price">â‚¹${item.price}</span><span class="pkg-rate">â‚¹<b>${item.price}</b></span><button class="view-details-btn" onclick="showIncludedTests('${item.name}', '${item.details.replace(/'/g, "\\'")}')">â„¹ï¸ View Details</button></div><div class="pkg-footer"><div class="qty-wrapper"><button class="add-btn" onclick="updateQty(this, 1)">Add</button><div class="qty-control"><button onclick="updateQty(this, -1)">-</button><span>0</span><button onclick="updateQty(this, 1)">+</button></div></div></div>`; document.getElementById("pkgGrid").appendChild(div); return; }Â 
Â  Â  let container = document.getElementById(item.category); if (!container && item.category === 'test') container = document.getElementById("test"); if (!container && item.category === 'usg') container = document.getElementById("usgContainer"); if (!container && item.category === 'xray') container = document.getElementById("xrayContainer"); if (!container && item.category === 'ct') container = document.getElementById("ctContainer"); if (!container && item.category === 'mri') container = document.getElementById("mriContainer"); if (!container && item.category === 'ecg') container = document.getElementById("ecgContainer"); if (!container && item.category === 'echo') container = document.getElementById("echoContainer");Â 
Â  Â  if (container) {Â 
Â  Â  Â  Â  if(container.id.includes('Container') === false && item.category !== 'test') { let innerCon = container.querySelector('[id$="Container"]'); if(innerCon) container = innerCon; }Â 
Â  Â  Â  Â  const div = document.createElement('div'); div.className = 'card'; div.dataset.name = item.name; div.dataset.price = item.price; div.dataset.type = item.category;Â 
Â  Â  Â  Â  let contrastHtml = ""; if(item.category === 'ct' || item.category === 'mri') contrastHtml = `<label class="contrast-box"><input type="checkbox"> ğŸ’Š + Contrast (â‚¹3000)</label>`;
Â  Â  Â  Â  div.innerHTML = `<div><div class="card-info">${item.name}</div><div class="card-price-box"><span class="mrp-price">â‚¹${item.price}</span><span class="final-price">â‚¹<b>${item.price}</b></span></div></div><div class="qty-wrapper">${contrastHtml}<button class="add-btn" onclick="updateQty(this, 1)">ADD +</button><div class="qty-control"><button onclick="updateQty(this, -1)">-</button><span>0</span><button onclick="updateQty(this, 1)">+</button></div></div>`; container.appendChild(div);Â 
Â  Â  }Â 
}

function refreshPrices(plan){Â 
Â  Â  document.querySelectorAll('.plan').forEach(p=>{p.classList.remove('active');if(p.dataset.plan===plan)p.classList.add('active');});Â 
Â  Â  const testDisc = discountMap[plan]; const centerDisc = (plan==='platinum')?0.20 : (plan==='gold'?0.10:0.05);
Â  Â  document.querySelectorAll('.card,.pkg-card').forEach(c=>{
Â  Â  Â  Â  const op = parseInt(c.dataset.price); const t = c.dataset.type; let d = (t==='test' || t==='package') ? testDisc : centerDisc;
Â  Â  Â  Â  if(t==='package') d = discountMap['pkg_'+plan];
Â  Â  Â  Â  let final = Math.round(op - (op*d)); c.querySelector('.final-price b,.pkg-rate b').innerText="â‚¹"+final;
Â  Â  });Â 
Â  Â  document.querySelectorAll('.doc-card').forEach(c=>{Â 
Â  Â  Â  Â  const op = parseInt(c.dataset.price); let d = (plan==='platinum'?0.20 : (plan==='gold'?0.10 : 0.05));Â 
Â  Â  Â  Â  let final = Math.round(op - (op*d)); c.querySelector('.doc-fee').innerHTML = `<span style="text-decoration:line-through;color:#999;font-size:11px;">â‚¹${op}</span> â‚¹<span class="final-price"><b>${final}</b></span>`;
Â  Â  });Â 
Â  Â  if(document.getElementById("mainCartBox").style.display === 'flex') { toggleMainCart(); }
}

function filter(i,id){ let v=i.value.toLowerCase(); document.querySelectorAll(`#${id} .card`).forEach(c=>c.style.display=c.innerText.toLowerCase().includes(v)?'flex':'none'); }
function filterDocs(i){ let v=i.value.toLowerCase(); document.querySelectorAll('.doc-card').forEach(c=>c.style.display=c.innerText.toLowerCase().includes(v)?'flex':'none'); }

function applyCoupon(){Â 
Â  Â  const input = document.getElementById("couponCode"); const btn = document.querySelector(".coupon-section button"); const msg = document.getElementById("couponMsg");
Â  Â  if(activeCoupon) { activeCoupon = null; input.value = ""; input.disabled = false; btn.innerText = "APPLY"; btn.style.background = "#333"; msg.innerText = "Referral Code Removed"; msg.style.color = "orange"; toggleMainCart(); return; }
Â  Â  const val = input.value.trim().toUpperCase(); if(val === "") { showAlert("Enter a referral code"); return; }
Â  Â  let isValidCode = false; for (let mob in patientsDB) { if (patientsDB[mob].referral === val) { if (currentUser && currentUser.referral === val) { msg.innerText = "Cannot use your own code!"; msg.style.color = "red"; return; } isValidCode = true; break; } }
Â  Â  if(isValidCode){ activeCoupon = val; input.disabled = true; btn.innerText = "REMOVE"; btn.style.background = "#d32f2f"; msg.innerText = `Referral Applied: â‚¹50 OFF`; msg.style.color = "green"; toggleMainCart(); }Â 
Â  Â  else { activeCoupon = null; msg.innerText = "Invalid referral code!"; msg.style.color = "red"; toggleMainCart(); }
}

function togglePointUsage(){ usePoints=document.getElementById("pointCheck").checked; toggleMainCart(); }
function logoutUser(){ location.reload(); }
function bookDoctor(n,p,btn){ const c=btn.closest('.doc-card'); const dp=parseInt(c.querySelector('.final-price b').innerText.replace('â‚¹','')); if(confirm(`Book ${n} for â‚¹${dp}?`)) window.open(`https://wa.me/${WA_NUMBER}?text=${encodeURIComponent(`Doctor: ${n}, Fee: ${dp}`)}`,"_blank"); }
function showIncludedTests(t,d){ document.getElementById("detailsTitle").innerText=t; const l=document.getElementById("detailsList"); l.innerHTML=""; d.split(',').forEach(i=>{if(i.trim()){const x=document.createElement("li"); x.innerText=i.trim(); l.appendChild(x);}}); document.getElementById("overlay").style.display="block"; document.getElementById("detailsModal").style.display="block"; }

function openFormModal(url, title) {Â 
Â  Â  document.querySelectorAll('.popup-box').forEach(b => b.style.display = "none");Â 
Â  Â  document.getElementById("overlay").style.display = "block";Â 
Â  Â  const modal = document.getElementById("universalFormModal"); modal.style.display = "flex";Â 
Â  Â  document.getElementById("formTitle").innerText = title; document.getElementById("formFrame").src = url;Â 
}

function openPartnerModal() { document.getElementById("overlay").style.display = "block"; document.getElementById("partnerModal").style.display = "block"; }

function sendMedRequest(){ const m=document.getElementById("mobile").value; if(m.length!==10){showAlert("Enter Mobile");return;} window.open(`https://wa.me/${WA_NUMBER}?text=${encodeURIComponent(`ğŸ“‹ *Prescription Upload*\nMobile: ${m}\n\n*upload your doctor prescription now...*`)}`,"_blank"); }
function sendHospRequest(){ window.open(`https://wa.me/${WA_NUMBER}?text=${encodeURIComponent(`ğŸ¥ *Hospital Lead*\nMobile: ${document.getElementById("mobile").value}`)}`,"_blank"); }
function sendForgotPassReq(){ const m=document.getElementById("loginMob").value; const p=document.getElementById("newPassInput").value; if(m.length<10){showAlert("Enter Mobile first");return;} if(!p){showAlert("Enter New Pass");return;} window.open(`https://wa.me/${WA_NUMBER}?text=${encodeURIComponent(`Hey Bhavya Diagnostics, Reset Pass\nMob: ${m}\nNew Pass: ${p}`)}`,"_blank"); closeAllPopups(); }
function clearMainCart(){ tempSelection=[]; toggleMainCart(); document.getElementById("topProceedBtn").innerText="Cart Empty"; document.getElementById("topProceedBtn").classList.remove("active"); document.getElementById("finalCount").innerText="0"; }
function payOnline() { const amt = document.getElementById("payAmount").innerText; if(amt == 0) return; window.location.href = `upi://pay?pa=${UPI_ID}&pn=BhavyaDiagnostics&am=${amt}&cu=INR`; }

function bookWithPayment(){Â 
Â  Â  const id = "B-" + Math.floor(10000 + Math.random() * 90000); const amt = document.getElementById("payAmount").innerText;Â 
Â  Â  let msg = `ğŸŒŸ *New Booking Request*\nğŸ†” ID: ${id}\nğŸ‘¤ Patient: ${document.getElementById("qName").value}\nğŸ“± Mobile: ${document.getElementById("mobile").value}\n------------------\n`;Â 
Â  Â  const currentPlan = document.querySelector('.plan.active').dataset.plan;
Â  Â  const testDisc = discountMap[currentPlan]; const centerDisc = (currentPlan === 'platinum') ? 0.20 : (currentPlan === 'gold' ? 0.10 : 0.05);
Â  Â  Object.keys(masterBookingData).forEach(cat => {Â 
Â  Â  Â  Â  let d = masterBookingData[cat]; let items = tempSelection.filter(i => i.type === cat);Â 
Â  Â  Â  Â  let locationName = d.lab || d.center || "Bhavya Diagnostics";
Â  Â  Â  Â  let finalAddress = (cat === 'test' || cat === 'package') ? (d.mode === 'Home' ? `${d.address}, ${d.city}` : centerAddressDB["Ved"]) : (centerAddressDB[locationName] || centerAddressDB["Default"]);
Â  Â  Â  Â  msg += `ğŸ“Œ *${cat.toUpperCase()}*\nğŸ¢ Center: ${locationName} (${d.mode})\nğŸ“… Schedule: ${d.date} | ğŸ•’ ${d.time}\nğŸ“ Addr: ${finalAddress}\n`;
Â  Â  Â  Â  items.forEach((i, idx) => {Â 
Â  Â  Â  Â  Â  Â  let discount = (cat === 'test' || cat === 'package') ? testDisc : centerDisc; if(cat === 'package') discount = discountMap['pkg_' + currentPlan];
Â  Â  Â  Â  Â  Â  let finalPrice = Math.round(i.price - (i.price * discount)); msg += `${idx + 1}. ${i.name} - *â‚¹${finalPrice}*\n`; if(i.contrast) msg += `Â  Â  (+ Contrast: â‚¹3000)\n`;
Â  Â  Â  Â  });
Â  Â  Â  Â  msg += `------------------\n`;
Â  Â  });Â 
Â  Â  if(activeCoupon) msg += `ğŸŸï¸ Referral Used: *${activeCoupon}* (-â‚¹50)\n`; if(usePoints) msg += `ğŸ’° Wallet Points Used: Yes\n`; msg += `âœ… *Final Payable: â‚¹${amt}*`;
Â  Â  window.open(`https://wa.me/${WA_NUMBER}?text=${encodeURIComponent(msg)}`, "_blank"); closeAllPopups(); clearMainCart();Â 
}

function verifyPartner() { const id = document.getElementById("partnerId").value.toUpperCase().trim(); const pass = document.getElementById("partnerPass").value.trim(); if (partnersDB[id] && partnersDB[id].pass === pass) { document.getElementById("partnerLoginForm").style.display = "none"; document.getElementById("partnerCancelBtn").style.display = "none"; document.getElementById("partnerDashboard").style.display = "block"; document.getElementById("partnerWelcomeMsg").innerHTML = `Welcome, <b>${partnersDB[id].name}</b>`; } else { showAlert("âŒ Wrong ID or Password!"); } }
function shareReferral() { const code = document.getElementById("dashRef").innerText; const msg = `Hey! Use my code *${code}* on Bhavya Diagnostics to get discounts on Blood Tests.`; window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`, "_blank"); }
function toggleAddress(show) { const b = document.getElementById("qAddressBox"); if(b) b.style.display = show?"block":"none"; }
function selectOpt(btn, grp, val) { btn.parentElement.querySelectorAll('.option-btn').forEach(s => s.classList.remove('selected')); btn.classList.add('selected'); }
function selectTime(el){ document.querySelectorAll('.time-slot').forEach(t=>t.classList.remove('selected')); el.classList.add('selected'); }
function closeAllPopups(){ document.querySelectorAll('.popup-box').forEach(b=>b.style.display="none"); document.getElementById("overlay").style.display="none"; document.getElementById("customAlert").style.display="none"; }
function showAlert(msg) { document.getElementById("customAlertMsg").innerText = msg; document.getElementById("overlay").style.display = "block"; document.getElementById("customAlert").style.display = "block"; }
function closeCustomAlert() { document.getElementById("customAlert").style.display = "none"; if(document.querySelectorAll('.popup-box[style*="display: block"], .popup-box[style*="display: flex"]').length === 0) document.getElementById("overlay").style.display = "none"; }

async function fetchHistory(mob) {
Â  Â  const histCon = document.getElementById("notifyContainer"); const repCon = document.getElementById("reportContainer");
Â  Â  histCon.innerHTML = '<div style="text-align:center;padding:10px;color:#999;">Loading...</div>'; repCon.innerHTML = '<div style="text-align:center;padding:10px;color:#999;">Checking...</div>';
Â  Â  try {
Â  Â  Â  Â  let res = await fetch(RAW_HISTORY_URL); if(!res.ok) res = await fetch(HISTORY_DATA_URL);
Â  Â  Â  Â  const csvText = await res.text(); const rows = csvText.split('\n').slice(1);Â 
Â  Â  Â  Â  let histHtml = "", repHtml = "", foundHist = false, foundRep = false;
Â  Â  Â  Â  rows.forEach(row => {
Â  Â  Â  Â  Â  Â  const cols = row.split(',').map(c => c.replace(/"/g, '').trim());
Â  Â  Â  Â  Â  Â  if (cols[2] === mob) {
Â  Â  Â  Â  Â  Â  Â  Â  foundHist = true; const rowDate = cols[0], rowMsg = cols[1], rowType = cols[3] || "TEST", rowLink = cols[4] || "";
Â  Â  Â  Â  Â  Â  Â  Â  histHtml += `<div class="list-item"><div style="flex:1;"><div style="display:flex; align-items:center; gap:8px; margin-bottom:4px;"><span style="background:#e3f2fd; color:#0a73c0; font-size:9px; font-weight:800; padding:2px 6px; border-radius:4px;">${rowType}</span><span style="font-size:10px; color:#999;">${rowDate}</span></div><div class="list-title">${rowMsg}</div></div></div>`;
Â  Â  Â  Â  Â  Â  Â  Â  if(rowLink && rowLink.length > 5) { foundRep = true; repHtml += `<div class="list-item"><div><div class="list-title">ğŸ“„ ${rowType} Report</div><div class="list-date">${rowDate}</div></div><a href="${rowLink}" target="_blank" class="action-icon icon-green">â¬‡ Download</a></div>`; }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  Â  Â  histCon.innerHTML = foundHist ? histHtml : '<div style="text-align:center;padding:10px;color:#999;">No bookings found.</div>';
Â  Â  Â  Â  repCon.innerHTML = foundRep ? repHtml : '<div style="text-align:center;padding:10px;color:#999;">No reports available yet.</div>';
Â  Â  } catch(e) { histCon.innerHTML = '<div style="text-align:center;padding:10px;color:red;">Error loading history.</div>'; repCon.innerHTML = '<div style="text-align:center;padding:10px;color:red;">Error loading reports.</div>'; }
}
</script>
</body>
</html>
