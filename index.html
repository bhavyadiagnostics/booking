<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Bhavya Diagnostics</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

<style>
/* ================= CSS STYLES (SAME MODERN DESIGN) ================= */
* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
body{margin:0;font-family:-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;background:#f0f2f5;padding-bottom:120px;}

/* HEADER */
.summary{position:sticky;top:0;background:#fff;padding:12px 15px;box-shadow:0 2px 10px rgba(0,0,0,0.1);z-index:900;border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center; width: 100%; height: 60px;}
.header-left { display: flex; align-items: center; gap: 10px; }
.menu-btn { background: none; border: none; font-size: 24px; cursor: pointer; padding: 0; color: #333; line-height: 1; }
.summary-info { font-size:12px; color:#666; margin-bottom: 2px; }
.summary-total { font-size:18px; font-weight:800; color:#0a73c0; }

/* TOP PROCEED BUTTON */
.top-proceed-btn { background: #ccc; color: white; padding: 8px 15px; border-radius: 25px; font-weight: bold; font-size: 13px; border: none; cursor: not-allowed; transition: 0.3s; white-space: nowrap; flex-shrink: 0; }
.top-proceed-btn.active { background: linear-gradient(135deg, #2e7d32, #1b5e20); cursor: pointer; box-shadow: 0 4px 10px rgba(46, 125, 50, 0.3); }

/* ACTION BUTTONS */
.action-buttons { display:flex; gap:8px; padding:10px; background:#fff; position: relative; z-index: 950; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
.action-buttons button { flex:1; border:none; padding:12px 5px; border-radius:8px; color:#fff; font-size:12px; cursor:pointer; font-weight:700; letter-spacing:0.3px; white-space:nowrap; transition: 0.2s; }
.upload-rx { background:linear-gradient(45deg, #9c27b0, #673ab7); }
.view-cart { background:#333; }
.my-info-btn { background: #0a73c0; }
.my-info-btn.logged-in { background: #4caf50; }

/* PROFESSIONAL MOBILE INPUT UI */
.mobile-input-container { background: #fff; padding: 15px 20px; margin: 10px; border-radius: 16px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); border: 1px solid #fff; display: flex; align-items: center; gap: 15px; transition: 0.3s; }
.mobile-input-container:focus-within { border-color: #0a73c0; }
.mobile-icon-box { width: 40px; height: 40px; background: #e3f2fd; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 20px; }
.mobile-text-group { flex: 1; display: flex; flex-direction: column; }
.mobile-label { font-size: 11px; font-weight: 700; color: #888; text-transform: uppercase; margin-bottom: 2px; }
.mobile-real-input { border: none; background: transparent; font-size: 18px; font-weight: 800; color: #333; outline: none; width: 100%; letter-spacing: 1px; }
.plan-badge-status { font-size: 10px; padding: 3px 8px; border-radius: 6px; background: #f5f5f5; color: #999; font-weight: bold; white-space: nowrap; }
.plan-badge-status.active { background: #e8f5e9; color: #2e7d32; border: 1px solid #c8e6c9; }

/* BANNERS */
.top-banner { display: none; margin: 10px; padding: 15px; border-radius: 12px; align-items: center; justify-content: space-between; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
.tb-gold { background: linear-gradient(to right, #fff8e1, #fff); border-left: 5px solid #ffb300; }
.tb-plat { background: linear-gradient(to right, #eceff1, #fff); border-left: 5px solid #607d8b; }
.tb-title { font-weight: 800; font-size: 14px; color: #333; }
.tb-desc { font-size: 11px; color: #666; }
.tb-btn { background: #333; color: white; border: none; padding: 5px 12px; border-radius: 20px; font-size: 10px; font-weight: bold; }
.vip-badge { display:none; margin:10px; background:linear-gradient(45deg, #333, #000); color:gold; padding:15px; border-radius:12px; text-align:center; font-weight:bold; box-shadow:0 5px 15px rgba(0,0,0,0.2); }

/* SIDEBAR */
.sidebar-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 4000; display: none; backdrop-filter: blur(2px); }
.sidebar { position: fixed; top: 0; left: -280px; width: 280px; height: 100%; background: #fff; z-index: 4100; transition: 0.3s; box-shadow: 2px 0 10px rgba(0,0,0,0.1); display: flex; flex-direction: column; }
.sidebar.open { left: 0; }
.sidebar-header { background: #0a73c0; color: white; padding: 20px; font-size: 18px; font-weight: bold; }
.sidebar-menu { padding: 10px; overflow-y: auto; flex: 1; }
.menu-item { display: flex; align-items: center; gap: 15px; padding: 15px; border-bottom: 1px solid #f0f0f0; color: #333; font-size: 14px; cursor: pointer; }
.sidebar-footer { padding: 20px; font-size: 11px; color: #999; text-align: center; border-top: 1px solid #eee; }

/* NAVIGATION */
.nav-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; padding: 10px; background: #fff; margin-bottom: 10px; }
.nav-btn { padding: 10px 5px; border: 1px solid #eee; border-radius: 12px; background: #f8f9fa; font-weight: 600; cursor: pointer; font-size: 11px; color: #444; transition: 0.2s; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 55px; }
.nav-btn.active { background: #e3f2fd; color: #0a73c0; border-color: #0a73c0; transform: translateY(-1px); box-shadow: 0 4px 8px rgba(10, 115, 192, 0.2); }

/* SECTIONS & CARDS */
.section{display:none;padding:10px}
.section.active{display:block !important;}
.search{width:100%;padding:12px;border-radius:8px;border:1px solid #ddd;font-size:15px;box-sizing:border-box;outline:none;transition:0.3s; margin-bottom:15px; background: #fff url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="%23999" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>') no-repeat 95% center; }

.plan-row{display:flex;gap:10px;margin-bottom:20px;background:#fff;padding:10px;border-radius:12px;}
.plan{flex:1;background:#f8f9fa;border:2px solid transparent;border-radius:10px;padding:12px 5px;text-align:center;font-size:12px;cursor:pointer;position:relative;font-weight:600;color:#555;transition:0.2s}
.plan.active{border-color:#0a73c0;background:#e8f3ff;color:#0a73c0;}
.plan.locked { opacity: 0.4; pointer-events: none; filter: grayscale(1); position: relative; background: #eee; }
.plan.locked::after { content: "üîí"; position: absolute; top: 5px; right: 5px; font-size: 14px; }

.tag{position:absolute;top:-10px;right:-5px;background:linear-gradient(45deg, #ff9800, #ff5722);color:#fff;font-size:9px;padding:3px 8px;border-radius:10px;font-weight:bold;}
.tag.green{background:linear-gradient(45deg, #43a047, #1b5e20); color:#fff;}

.card, .pkg-card { background: #fff; border-radius: 16px; padding: 12px; margin-bottom: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); display: grid; grid-template-columns: 1fr 90px; gap: 10px; align-items: center; border: 1px solid #f0f0f0; transition: transform 0.2s; position: relative; }
.card.selected, .pkg-card.selected { border-color: #0a73c0; background: #fbfdff; transform: scale(1.01); }
.card-info, .pkg-name { font-size: 14px; font-weight: 700; color: #333; margin-bottom: 4px; line-height: 1.3; }
.mrp-price { font-size: 12px; color: #999; text-decoration: line-through; margin-right: 5px; }
.final-price, .pkg-rate { font-size: 16px; color: #2e7d32; font-weight: 800; }
.unlock-badge { font-size:10px; font-weight:bold; background:#fff8e1; color:#ff8f00; padding:2px 5px; border-radius:4px; display:inline-block; margin-bottom:5px; border:1px solid #ffb300; }
.platinum-badge { background:#eceff1; color:#455a64; border-color:#607d8b; }

.add-btn { background: linear-gradient(135deg, #0a73c0, #005b9f); color: white; border: none; padding: 8px 0; width:100%; border-radius: 25px; cursor: pointer; font-weight: bold; font-size: 13px; }
.qty-control { display: none; align-items: center; background: #e3f2fd; border-radius: 25px; padding: 2px; border: 1px solid #0a73c0; width:100%; justify-content: space-between; }
.qty-control button { background: transparent; border: none; color: #0a73c0; font-weight: bold; font-size: 18px; width: 30px; }
.doc-card { display:flex; flex-direction: row; gap: 15px; align-items: center; background:#fff; padding:10px; border-radius:12px; margin-bottom:10px; box-shadow:0 2px 5px rgba(0,0,0,0.05); }
.doc-img { width: 60px; height: 60px; border-radius: 50%; object-fit: cover; background: #eee; border: 2px solid #fff; }
.book-btn { background: #2e7d32; color: white; border: none; padding: 8px 15px; border-radius: 20px; font-weight: bold; font-size: 12px; margin-left:auto;}
.contrast-box { font-size: 11px; font-weight: bold; color: #d32f2f; margin-bottom: 5px; display: block; background: #ffebee; padding: 5px; border-radius: 5px; border: 1px dashed #d32f2f; cursor: pointer; }

/* MODERN BOTTOM SHEETS (60-70% Height) */
#mainCartBox, #stepModal { 
    top: auto; bottom: 0; left: 0; transform: none; 
    width: 100%; max-width: 100%; 
    border-radius: 25px 25px 0 0; padding: 0; 
    display: none; flex-direction: column; 
    height: auto; max-height: 80vh; 
    animation: slideUp 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); 
    z-index: 5200 !important; box-shadow: 0 -5px 25px rgba(0,0,0,0.1);
}
.popup-overlay{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);z-index:5000;backdrop-filter:blur(5px)}
.popup-box{display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);width:90%; max-width:350px; background:#fff; border-radius:20px; padding:20px; z-index:5100; max-height:85vh; overflow-y:auto; box-shadow: 0 10px 30px rgba(0,0,0,0.2); box-sizing:border-box}

/* FULL SCREEN FORM POPUP */
#universalFormModal {
    width: 100% !important; max-width: 100% !important; height: 85vh !important;
    top: auto !important; bottom: 0 !important; left: 0 !important; transform: none !important;
    border-radius: 25px 25px 0 0 !important; padding: 0 !important;
    display: none; flex-direction: column; z-index: 6000 !important; background: #fff;
    animation: slideUp 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
}
.form-header { padding: 15px 20px; background: #fff; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; border-radius: 25px 25px 0 0; }
.form-iframe { width: 100%; flex: 1; border: none; background: #fff; }
@keyframes slideUp { from{transform:translateY(100%);} to{transform:translateY(0);} }

.sheet-handle { width: 40px; height: 5px; background: #e0e0e0; border-radius: 5px; margin: 0 auto 15px auto; }
.sheet-header { padding: 15px 20px; background: #fff; border-bottom: 1px solid #f0f0f0; text-align: center; border-radius: 25px 25px 0 0; position: relative; }
.sheet-header h3 { margin: 0; color: #333; font-size: 18px; font-weight: 800; }
.clear-cart-btn { position: absolute; right: 15px; top: 15px; background: #ffebee; color: #d32f2f; border: 1px solid #ef9a9a; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: bold; cursor: pointer; }
.sheet-body { flex-grow: 1; overflow-y: auto; padding: 20px; min-height: 200px; padding-bottom: 100px; }
.sheet-footer { position: sticky; bottom: 0; left: 0; width: 100%; padding: 15px 20px; background: #fff; border-top: 1px solid #eee; box-shadow: 0 -5px 15px rgba(0,0,0,0.03); }

.booking-label { font-size: 12px; font-weight: 700; color: #888; margin: 15px 0 8px 0; display: block; text-transform: uppercase; letter-spacing: 0.5px; }
.med-input { width: 100%; padding: 12px; margin-bottom: 5px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; background: #fafafa; font-size: 14px; }
.time-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-top: 5px; }
.time-slot { padding: 10px 2px; border: 1px solid #ddd; text-align: center; border-radius: 8px; cursor: pointer; font-size: 12px; font-weight: 600; color: #555; background: #fff; }
.time-slot.selected { background: #0a73c0; color: white; border-color: #0a73c0; }
.option-group { display: flex; gap: 10px; margin-bottom: 10px; }
.option-btn { flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 8px; background: #fff; color: #555; font-weight: bold; cursor: pointer; text-align: center; font-size: 13px; transition: 0.2s; }
.option-btn.selected { background: #e3f2fd; color: #0a73c0; border-color: #0a73c0; box-shadow: 0 2px 5px rgba(10,115,192,0.2); }

/* BUTTONS */
.whatsapp-btn { background: linear-gradient(45deg, #25D366, #128C7E); color: white; font-size: 15px; font-weight: bold; padding: 14px; border-radius: 30px; border: none; width: 100%; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; }
.pay-btn { background: linear-gradient(135deg, #673ab7, #512da8); color: white; font-size: 15px; font-weight: bold; padding: 14px; border-radius: 30px; border: none; width: 100%; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; margin-bottom: 8px; }
.next-btn { background: linear-gradient(135deg, #43a047, #1b5e20); color: white; padding: 15px; width: 100%; border: none; border-radius: 12px; font-size: 18px; font-weight: 800; cursor: pointer; box-shadow: 0 4px 15px rgba(27, 94, 32, 0.4); transition: 0.3s; }
.next-btn:active { transform: scale(0.98); }

.custom-alert-box { display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); width:80%; background:#fff; border-radius:15px; padding:20px; z-index:9999; text-align:center; }
.login-input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 10px; }
.login-btn { width: 100%; padding: 12px; background: #0a73c0; color: white; font-weight: bold; border: none; border-radius: 8px; cursor: pointer; }
.cart-group-header { background: #f0f2f5; padding: 8px 15px; font-size: 12px; font-weight: bold; color: #666; margin-top: 10px; border-radius: 4px; }
.cart-item-row { display: flex; justify-content: space-between; align-items: center; padding: 8px 15px; font-size: 13px; border-bottom: 1px solid #eee; }
.remove-item-btn { color: #f44336; font-size: 16px; cursor: pointer; margin-right: 10px; padding: 5px; }
.cart-details-row { padding: 5px 15px; font-size: 11px; color: #2e7d32; background: #f9f9f9; border-bottom: 1px solid #eee; font-style: italic; }
.share-btn { background: #25D366; color: white; border: none; padding: 5px 10px; border-radius: 15px; font-size: 11px; font-weight: bold; cursor: pointer; margin-left: 5px; }
.signup-section { margin-top: 20px; padding-top: 15px; border-top: 1px solid #eee; text-align: center; }
.signup-btn-large { width: 100%; padding: 12px; background: #ff9800; color: white; font-weight: bold; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; text-decoration: none; display: inline-block; box-sizing: border-box; }

.dashboard-container { display: none; padding: 10px; background: #fff; margin-bottom: 10px; border-bottom: 1px solid #eee; }
.dash-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
.dash-points { background: linear-gradient(45deg, #FFD700, #FFA500); color: white; padding: 15px; border-radius: 12px; text-align: center; font-weight: bold; flex: 1; margin-right: 10px; box-shadow: 0 4px 10px rgba(255, 165, 0, 0.3); }
.dash-details { flex: 1; display: flex; flex-direction: column; justify-content: center; font-size: 12px; color: #555; }
.dash-label { font-size: 10px; color: #999; text-transform: uppercase; letter-spacing: 0.5px; }
.dash-val { font-weight: bold; color: #333; font-size: 13px; margin-bottom: 5px; }
.highlight-plan { color: #0a73c0; background: #e3f2fd; padding: 2px 6px; border-radius: 4px; display: inline-block; }
.dash-fam-btn { padding: 6px 12px; border-radius: 20px; border: 1px solid #ddd; background: #fff; font-size: 12px; font-weight: bold; color: #555; cursor: pointer; display: inline-block; white-space: nowrap; margin-right: 5px;}
.dash-fam-btn.active { background: #0a73c0; color: white; border-color: #0a73c0; }
.dash-fam-add { color: #0a73c0; border: 1px dashed #0a73c0; }

/* NEW PROFESSIONAL HISTORY BUTTONS */
.dash-action-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; }
.dash-pro-btn { display: flex; align-items: center; gap: 10px; padding: 12px; border-radius: 14px; border: none; cursor: pointer; transition: 0.3s; position: relative; overflow: hidden; }
.btn-reports { background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); border: 1px solid #a5d6a7; }
.btn-history { background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); border: 1px solid #90caf9; }
.dash-pro-btn .icon-circle { width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 16px; background: rgba(255,255,255,0.8); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
.dash-pro-btn .btn-text { text-align: left; }
.btn-text .main-t { display: block; font-weight: 800; font-size: 12px; color: #2c3e50; }
.btn-text .sub-t { display: block; font-size: 9px; color: #546e7a; text-transform: uppercase; letter-spacing: 0.5px; }
.dash-pro-btn:active { transform: scale(0.96); opacity: 0.8; }

.partner-link { text-align: center; padding: 20px; color: #999; font-size: 12px; margin-top: 30px; cursor: pointer; text-decoration: underline; }
.admin-row { padding: 10px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
.status-badge { padding: 3px 8px; border-radius: 4px; font-size: 10px; font-weight: bold; color: white; }
.status-pending { background: #ff9800; }

/* Styles for List items in Profile */
.list-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 10px; border-bottom: 1px solid #eee; background: #fff; margin-bottom: 5px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
.list-title { font-weight: 700; font-size: 13px; color: #333; line-height: 1.2; }
.list-date { font-size: 10px; color: #999; }
.action-icon { font-size: 12px; text-decoration: none; font-weight: bold; }
.icon-green { color: #2e7d32; }
</style>
</head>

<body>

<div class="sidebar-overlay" id="sidebarOverlay" onclick="closeMenu()"></div>
<div class="sidebar" id="sidebar">
    <div class="sidebar-header"><span>Bhavya Diagnostics</span></div>
    <div class="sidebar-menu">
        <div class="menu-item" onclick="closeMenu()"><span class="menu-icon-span">üè†</span> Home</div>
        <div class="menu-item" onclick="closeMenu(); handleMyInfoClick()"><span class="menu-icon-span">üë§</span> My Profile</div>
        <div class="menu-item" onclick="window.open('https://www.bhavyadiagnostics.com/services-3', '_blank')"><span class="menu-icon-span">üõ†Ô∏è</span> Services</div>
        <div class="menu-item" onclick="window.open('https://www.bhavyadiagnostics.com/terms-conditions', '_blank')"><span class="menu-icon-span">üìú</span> Terms & Conditions</div>
        <div class="menu-item" onclick="window.open('https://www.bhavyadiagnostics.com/privacy-policy', '_blank')"><span class="menu-icon-span">üîí</span> Privacy Policy</div>
        <div class="menu-item" onclick="window.open('https://www.bhavyadiagnostics.com/contact-5', '_blank')"><span class="menu-icon-span">üìû</span> Help & Contact</div>
        <div class="menu-item" onclick="shareApp()"><span class="menu-icon-span">üì¢</span> Share App</div>
        <div class="menu-item" onclick="openPartnerModal()"><span class="menu-icon-span">üè•</span> Partner Login</div>
    </div>
    <div class="sidebar-footer">Ver 1.0.0 | Bhavya Diagnostics</div>
</div>

<div class="popup-overlay" id="overlay" onclick="closeAllPopups()"></div>
<div id="customAlert" class="custom-alert-box"><div class="alert-title">Notice</div><div id="customAlertMsg" class="alert-msg"></div><button class="alert-btn" onclick="closeCustomAlert()">OK</button></div>

<div class="summary">
    <div class="header-left">
        <button class="menu-btn" onclick="openMenu()">‚ò∞</button>
        <div>
            <div class="summary-info">Your Cart</div>
            <div class="summary-total">‚Çπ<span id="headerTotal">0</span> <span style="font-size:12px;color:#666;font-weight:normal">(<span id="finalCount">0</span>)</span></div>
        </div>
    </div>
    <button class="top-proceed-btn" id="topProceedBtn" onclick="startBookingQueue()">Cart Empty</button>
</div>

<div class="action-buttons">
  <button class="view-cart" onclick="toggleMainCart()">üõí Cart</button>
  <button class="upload-rx" onclick="sendMedRequest()">üìÑ Prescription</button>
  <button class="my-info-btn" id="btnMyInfo" onclick="handleMyInfoClick()">üë§ Login</button> 
</div>

<div id="topBannerGold" class="top-banner tb-gold" onclick="show('package', document.querySelector('.nav-btn:nth-child(2)'))">
    <div><div class="tb-title">üü° Upgrade to Gold</div><div class="tb-desc">Get 35% OFF on Tests</div></div>
    <button class="tb-btn">VIEW</button>
</div>
<div id="topBannerPlat" class="top-banner tb-plat" onclick="show('package', document.querySelector('.nav-btn:nth-child(2)'))">
    <div><div class="tb-title">üîò Go Platinum</div><div class="tb-desc">Get 50% OFF & VIP Service</div></div>
    <button class="tb-btn">VIEW</button>
</div>
<div id="topVipBadge" class="vip-badge">üëë MEMBER</div>

<div id="dashboardSection" class="dashboard-container">
    <div class="dash-header">
        <div class="dash-points">
            <div style="font-size:10px; opacity:0.8;">WALLET</div>
            <div style="font-size:24px;" id="dashPoints">0</div>
        </div>
        <div class="dash-details">
            <div class="dash-label">Plan</div>
            <div class="dash-val" id="dashPlan">Basic</div>
            <div class="dash-label">Referral Code</div>
            <div class="dash-val">
                <span id="dashRef" style="color:#e91e63">---</span>
                <button class="share-btn" onclick="shareReferral()">üì¢ Share</button>
            </div>
        </div>
    </div>
    
    <div style="margin-top:10px;">
        <div style="font-size:10px; font-weight:bold; color:#666; margin-bottom:5px; text-transform:uppercase;">Select Patient</div>
        <div id="dashFamilyContainer" style="display:flex; gap:8px; overflow-x:auto; padding-bottom:5px;"></div>
    </div>

    <div class="dash-action-grid">
        <button class="dash-pro-btn btn-reports" onclick="handleMyInfoClick()">
            <div class="icon-circle">üìÇ</div>
            <div class="btn-text">
                <span class="main-t">My Reports</span>
                <span class="sub-t">View Lab Results</span>
            </div>
        </button>
        <button class="dash-pro-btn btn-history" onclick="handleMyInfoClick()">
            <div class="icon-circle">üìú</div>
            <div class="btn-text">
                <span class="main-t">Order History</span>
                <span class="sub-t">Past Bookings</span>
            </div>
        </button>
    </div>
</div>

<div class="mobile-input-container">
    <div class="mobile-icon-box">üì±</div>
    <div class="mobile-text-group">
        <div style="display:flex; justify-content:space-between; width:100%;">
            <span class="mobile-label">Patient Mobile</span>
            <span id="planStatus" class="plan-badge-status">Pending</span>
        </div>
        <input id="mobile" class="mobile-real-input" type="tel" maxlength="10" placeholder="10 Digit Number" onkeyup="applyPlanByMobile()">
    </div>
</div>

<div class="nav-grid">
    <button class="nav-btn active" onclick="show('test',this)">ü©∏ Blood Test</button>
    <button class="nav-btn" onclick="show('package',this)">üì¶ Packages</button>
    <button class="nav-btn" onclick="show('medicine',this)">üíä Medicine</button>
    <button class="nav-btn" onclick="show('usg',this)">üñ•Ô∏è USG</button>
    <button class="nav-btn" onclick="show('xray',this)">ü¶¥ X-Ray</button>
    <button class="nav-btn" onclick="show('ct',this)">üß† CT Scan</button>
    <button class="nav-btn" onclick="show('mri',this)">üß≤ MRI</button>
    <button class="nav-btn" onclick="show('ecg',this)">üíì ECG</button>
    <button class="nav-btn" onclick="show('echo',this)">ü´Ä ECHO</button>
    <button class="nav-btn" onclick="show('doctor',this)">üë®‚öïÔ∏è Doctor</button>
    <button class="nav-btn" onclick="show('hospital',this)" style="grid-column: span 2; background:#ffebee; color:#d32f2f">üè• Hospital Admission</button>
</div>

<div id="test" class="section active">
    <input class="search" placeholder="Search Blood Tests..." onkeyup="filter(this,'test')">
    <div class="plan-row"><div class="plan active" data-plan="basic" onclick="manualPlan(this)">Basic<br>20%</div><div class="plan" data-plan="gold" onclick="manualPlan(this)">Gold<br>35%<div class="tag">POPULAR</div></div><div class="plan" data-plan="platinum" onclick="manualPlan(this)">Platinum<br>50%<div class="tag green">VIP</div></div></div>
    <div id="loadingMsg" style="text-align:center;padding:20px;color:#999">Loading Tests...</div>
</div>
<div id="package" class="section">
    <div class="plan-row"><div class="plan active" data-plan="basic" onclick="manualPlan(this)">Basic<br>10%</div><div class="plan" data-plan="gold" onclick="manualPlan(this)">Gold<br>20%<div class="tag">POPULAR</div></div><div class="plan" data-plan="platinum" onclick="manualPlan(this)">Platinum<br>30%<div class="tag green">VIP</div></div></div>
    <div class="pkg-grid" id="pkgGrid"></div>
</div>
<div id="medicine" class="section"><div class="med-box"><span class="med-icon">üíä</span><h3>Upload Prescription</h3><input id="medName" class="med-input" placeholder="üíä Medicine Name"><input id="medDuration" class="med-input" placeholder="üìÖ Duration"><button class="confirm-btn" onclick="sendMedRequest()" style="background: linear-gradient(135deg, #43a047, #1b5e20); color:white; padding:10px; border:none; border-radius:20px; width:100%;">üì∑ Upload & Order</button></div></div>
<div id="usg" class="section">
    <input class="search" placeholder="Search USG..." onkeyup="filter(this,'usg')">
    <div class="plan-row"><div class="plan active" data-plan="basic" onclick="manualPlan(this)">Basic<br>5%</div><div class="plan" data-plan="gold" onclick="manualPlan(this)">Gold<br>10%<div class="tag">POPULAR</div></div><div class="plan" data-plan="platinum" onclick="manualPlan(this)">Platinum<br>20%<div class="tag green">VIP</div></div></div>
    <div id="usgContainer"></div>
</div>
<div id="xray" class="section">
    <input class="search" placeholder="Search X-Ray..." onkeyup="filter(this,'xray')">
    <div class="plan-row"><div class="plan active" data-plan="basic" onclick="manualPlan(this)">Basic<br>5%</div><div class="plan" data-plan="gold" onclick="manualPlan(this)">Gold<br>10%<div class="tag">POPULAR</div></div><div class="plan" data-plan="platinum" onclick="manualPlan(this)">Platinum<br>20%<div class="tag green">VIP</div></div></div>
    <div id="xrayContainer"></div>
</div>
<div id="ct" class="section">
    <input class="search" placeholder="Search CT Scan..." onkeyup="filter(this,'ct')">
    <div class="plan-row"><div class="plan active" data-plan="basic" onclick="manualPlan(this)">Basic<br>5%</div><div class="plan" data-plan="gold" onclick="manualPlan(this)">Gold<br>10%<div class="tag">POPULAR</div></div><div class="plan" data-plan="platinum" onclick="manualPlan(this)">Platinum<br>20%<div class="tag green">VIP</div></div></div>
    <div id="ctContainer"></div>
</div>
<div id="mri" class="section">
    <input class="search" placeholder="Search MRI..." onkeyup="filter(this,'mri')">
    <div class="plan-row"><div class="plan active" data-plan="basic" onclick="manualPlan(this)">Basic<br>5%</div><div class="plan" data-plan="gold" onclick="manualPlan(this)">Gold<br>10%<div class="tag">POPULAR</div></div><div class="plan" data-plan="platinum" onclick="manualPlan(this)">Platinum<br>20%<div class="tag green">VIP</div></div></div>
    <div id="mriContainer"></div>
</div>
<div id="ecg" class="section">
    <div class="plan-row"><div class="plan active" data-plan="basic" onclick="manualPlan(this)">Basic<br>5%</div><div class="plan" data-plan="gold" onclick="manualPlan(this)">Gold<br>10%<div class="tag">POPULAR</div></div><div class="plan" data-plan="platinum" onclick="manualPlan(this)">Platinum<br>20%<div class="tag green">VIP</div></div></div>
    <div id="ecgContainer"></div>
</div>
<div id="echo" class="section">
    <div class="plan-row"><div class="plan active" data-plan="basic" onclick="manualPlan(this)">Basic<br>5%</div><div class="plan" data-plan="gold" onclick="manualPlan(this)">Gold<br>10%<div class="tag">POPULAR</div></div><div class="plan" data-plan="platinum" onclick="manualPlan(this)">Platinum<br>20%<div class="tag green">VIP</div></div></div>
    <div id="echoContainer"></div>
</div>
<div id="doctor" class="section">
    <input class="search" placeholder="Search Doctors..." onkeyup="filterDocs(this)">
    <div class="plan-row"><div class="plan active" data-plan="basic" onclick="manualPlan(this)">Basic<br>5%</div><div class="plan" data-plan="gold" onclick="manualPlan(this)">Gold<br>10%<div class="tag">POPULAR</div></div><div class="plan" data-plan="platinum" onclick="manualPlan(this)">Platinum<br>20%<div class="tag green">VIP</div></div></div>
    <div id="docContainer"></div>
</div>
<div id="hospital" class="section"><div style="background:#fff; padding:20px; border-radius:12px; border-left:5px solid #e91e63;"><h3 style="margin-top:0">üè• Hospital Admission</h3><button class="confirm-btn" onclick="sendHospRequest()" style="background:#e91e63; color:white; border:none; padding:10px; border-radius:20px; width:100%;">Send Enquiry</button></div></div>

<div class="partner-link" onclick="openPartnerModal()">üè• Partner/Lab Login (Secure Area)</div>

<div class="popup-box" id="stepModal">
    <div class="sheet-header">
        <div class="sheet-handle"></div>
        <h3 id="stepTitle" style="margin:0;color:#0a73c0">Booking</h3>
        <div id="stepSubtitle" style="font-size:12px; color:#666;"></div>
    </div>
    <div class="sheet-body" id="dynamicFormBody"></div>
    <div class="sheet-footer"><button class="next-btn" onclick="nextQueueStep()">Next ‚ûî</button></div>
</div>

<div class="popup-box" id="mainCartBox">
    <div class="sheet-header">
        <div class="sheet-handle"></div>
        <h3 style="margin:0;color:#0a73c0">Final Cart</h3>
        <button class="clear-cart-btn" onclick="clearMainCart()">Clear Cart</button>
    </div>
    <div class="sheet-body" id="finalCartItems"></div>
    <div class="sheet-footer">
        <div class="coupon-section"><input id="couponCode" style="flex:2;padding:10px;border:1px dashed #0a73c0;border-radius:8px;" placeholder="Referral Code"><button onclick="applyCoupon()" style="flex:1;background:#333;color:white;border:none;border-radius:8px;margin-left:5px;">APPLY</button></div>
        <div id="couponMsg" style="font-size:11px;margin-top:5px;"></div>
        <div id="redeemBox" style="background:#fff8e1;border:1px dashed #ffb300;padding:12px;border-radius:10px;margin-top:10px;display:none;justify-content:space-between;"><label style="font-weight:bold;color:#f57f17;"><input type="checkbox" id="pointCheck" onchange="togglePointUsage()"> Redeem <span id="availPoints">0</span> Points</label><div style="font-weight:bold;">- ‚Çπ<span id="discountVal">0</span></div></div>
        <div style="display:flex; justify-content:space-between; margin:10px 0;"><span>Payable:</span> <b>‚Çπ<span id="payAmount">0</span></b></div>
        <button onclick="payOnline()" class="pay-btn"><span>Pay Now (UPI)</span><span>üí≥</span></button>
        <button onclick="bookWithPayment()" class="whatsapp-btn"><span>Book via WhatsApp</span><span>üí¨</span></button>
        <button onclick="closeAllPopups()" style="width:100%; margin-top:10px; padding:10px; background:transparent; border:none; color:#666;">Close</button>
    </div>
</div>

<div class="popup-box" id="loginModal"><h3 style="text-align:center; color:#0a73c0">Login</h3><input type="tel" id="loginMob" class="login-input" placeholder="Mobile"><input type="password" id="loginPass" class="login-input" placeholder="Password"><button class="login-btn" onclick="checkLogin()">Login</button><div class="signup-section"><button onclick="openFormModal(SIGNUP_FORM_URL, 'New Patient Registration')" class="signup-btn-large">üìù Create Account</button></div><button onclick="closeAllPopups()" style="width:100%; margin-top:10px; background:transparent; border:none;">Cancel</button></div>
<div class="popup-box" id="infoModal"><h3 style="margin-top:0; color:#0a73c0;">My Profile</h3><div id="patientDataList" style="margin-bottom:10px"></div><div class="list-header"><h4 style="margin:0; color:#333; font-size:13px;">üìë My Reports</h4></div><div id="reportContainer" style="max-height:120px; overflow-y:auto; border:1px solid #eee; padding:5px; border-radius:8px;"></div><div class="list-header"><h4 style="margin:0; color:#333; font-size:13px;">üîî Order History</h4></div><div id="notifyContainer" style="max-height:120px; overflow-y:auto; border:1px solid #eee; padding:5px; border-radius:8px;"></div><button onclick="logoutUser()" style="width:100%; padding:10px; background:#ffebee; color:red; border:none; margin-top:10px; border-radius:8px;">Logout</button></div>

<div class="popup-box" id="universalFormModal">
    <div class="form-header">
        <div class="sheet-handle" style="margin:0"></div>
        <b id="formTitle" style="color:#0a73c0">Form</b>
        <button onclick="closeAllPopups()" style="background:transparent;border:none;font-size:24px;color:#333;">&times;</button>
    </div>
    <iframe id="formFrame" class="form-iframe" src=""></iframe>
</div>

<div class="popup-box" id="partnerModal"><h3 style="margin-top:0;color:#d32f2f;text-align:center">üîí Partner Access</h3><div id="partnerLoginForm"><input id="partnerId" class="login-input" placeholder="Partner ID"><input type="password" id="partnerPass" class="login-input" placeholder="Password"><button class="login-btn" onclick="verifyPartner()" style="background:#333">Login to Dashboard</button></div><div id="partnerDashboard" style="display:none; text-align:center;"><div style="font-size:50px;">‚úÖ</div><h2 style="color:#2e7d32; margin:10px 0;">Login Successful!</h2><p id="partnerWelcomeMsg" style="color:#555;"></p><div style="margin-top:20px; padding:15px; background:#f9f9f9; border-radius:10px; border:1px dashed #ccc;"><button onclick="openFormModal(PARTNER_FORM_URL, 'Partner Portal')" style="background:#0a73c0; color:white; border:none; padding:12px 25px; border-radius:25px; font-weight:bold;">üöÄ Open Portal</button></div><button onclick="location.reload()" style="margin-top:20px; background:transparent; border:none; color:#999; text-decoration:underline;">Logout</button></div><button id="partnerCancelBtn" onclick="closeAllPopups()" style="width:100%;padding:10px;background:transparent;border:none;color:#999;margin-top:5px">Cancel</button></div>
<div class="popup-box" id="upgradeListModal"><h3 id="upgradeTitle" style="margin-top:0;color:#0a73c0;text-align:center;"></h3><div id="upgradeGrid" class="pkg-grid"></div><button onclick="closeAllPopups()" style="width:100%;padding:10px;background:#ddd;border:none;border-radius:8px;margin-top:10px">Close</button></div>
<div class="popup-box" id="detailsModal"><h3 id="detailsTitle" style="margin-top:0;color:#0a73c0;"></h3><ul id="detailsList" style="padding-left:20px;font-size:13px;color:#555;line-height:1.6"></ul><button onclick="closeAllPopups()" style="width:100%;padding:10px;background:#ddd;border:none;border-radius:8px;margin-top:10px">Close</button></div>
<div class="popup-box" id="compareModal"><h3 style="margin-top:0;color:#0a73c0;text-align:center">‚ú® Membership Benefits</h3><table class="comp-table"><thead><tr><th style="text-align:left; background:#eee; color:#333;">Feature</th><th style="background:#eee; color:#666;">Basic</th><th style="background:#fff8e1; color:#f57f17;">Gold</th><th style="background:#eceff1; color:#37474f;">Plat.</th></tr></thead><tbody><tr><td style="text-align:left; font-weight:bold;">ü©∏ Blood Test</td><td>20%</td><td style="font-weight:bold; color:#f57f17">35%</td><td style="font-weight:bold; color:#37474f">50%</td></tr><tr><td style="text-align:left; font-weight:bold;">ü¶¥ X-Ray/USG</td><td>5%</td><td style="font-weight:bold; color:#f57f17">10%</td><td style="font-weight:bold; color:#37474f">20%</td></tr><tr><td style="text-align:left; font-weight:bold;">üè† Home Coll.</td><td>Paid</td><td style="font-weight:bold; color:#f57f17">‚Çπ50</td><td style="font-weight:bold; color:#37474f">FREE</td></tr><tr><td style="text-align:left; font-weight:bold;">üë®‚öïÔ∏è Doctor Fees</td><td>Full</td><td style="font-weight:bold; color:#f57f17">10% Off</td><td style="font-weight:bold; color:#37474f">20% Off</td></tr></tbody></table><button onclick="closeAllPopups()" style="width:100%;padding:12px;background:#333;color:white;font-weight:bold;border:none;border-radius:8px;margin-top:10px">Close</button></div>
<div class="popup-box" id="forgotPassModal"><h3 style="margin-top:0; color:#0a73c0;">Reset Password</h3><input type="text" id="newPassInput" class="login-input" placeholder="New Password"><button class="login-btn" onclick="sendForgotPassReq()" style="margin-top:10px;">Send Request</button><button onclick="closeAllPopups()" style="width:100%; padding:10px; background:transparent; border:none; color:#999;">Cancel</button></div>
<div class="popup-box" id="termsModal"><h3 style="margin-top:0; color:#0a73c0">Terms & Conditions</h3><div style="max-height:60vh; overflow-y:auto; font-size:12px; color:#555;"><p><b>1. General Role:</b> Bhavya Diagnostics connects patients with NABL Labs.</p><p><b>2. Booking:</b> Confirmation via WhatsApp.</p></div><button onclick="closeAllPopups()" style="width:100%; margin-top:10px; padding:10px; border:none; background:#eee;">Close</button></div>
<div class="popup-box" id="privacyModal"><h3 style="margin-top:0; color:#0a73c0">Privacy Policy</h3><div style="font-size:12px; color:#555;"><p>We collect your Name, Mobile, and Health Data only for services.</p></div><button onclick="closeAllPopups()" style="width:100%; margin-top:10px; padding:10px; border:none; background:#eee;">Close</button></div>
<div class="popup-box" id="helpModal"><h3 style="margin-top:0; color:#0a73c0">Help & Contact</h3><div style="text-align:center;"><p>üìû +91 83979 85922</p></div><button onclick="closeAllPopups()" style="width:100%; margin-top:10px; padding:10px; border:none; background:#eee;">Close</button></div>

<script>
/* üî¥ CONFIGURATION */
const RAW_SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSpcKVcbX9ZXEsSyka1rzNprfUjwlAShQLHFiPeaQETHaoYaxXXMQXT4dQ-zIu2hpn9feD-wGy_fjdW/pub?gid=0&single=true&output=csv";
const RATE_SHEET_URL = `https://api.allorigins.win/raw?url=${encodeURIComponent(RAW_SHEET_URL)}`;

const RAW_PATIENT_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSpcKVcbX9ZXEsSyka1rzNprfUjwlAShQLHFiPeaQETHaoYaxXXMQXT4dQ-zIu2hpn9feD-wGy_fjdW/pub?gid=1566470488&single=true&output=csv";
const PATIENT_SHEET_URL = `https://api.allorigins.win/raw?url=${encodeURIComponent(RAW_PATIENT_URL)}`;

const RAW_PARTNER_DB_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSpcKVcbX9ZXEsSyka1rzNprfUjwlAShQLHFiPeaQETHaoYaxXXMQXT4dQ-zIu2hpn9feD-wGy_fjdW/pub?gid=988786822&single=true&output=csv";
const PARTNER_DB_URL = `https://api.allorigins.win/raw?url=${encodeURIComponent(RAW_PARTNER_DB_URL)}`;

const RAW_HISTORY_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSpcKVcbX9ZXEsSyka1rzNprfUjwlAShQLHFiPeaQETHaoYaxXXMQXT4dQ-zIu2hpn9feD-wGy_fjdW/pub?gid=1140710592&single=true&output=csv";
const HISTORY_DATA_URL = `https://api.allorigins.win/raw?url=${encodeURIComponent(RAW_HISTORY_URL)}`;

const PARTNER_FORM_URL = "https://docs.google.com/forms/d/e/1FAIpQLScSOZbFl-dKDA4jy5cBCQav3zpMXjgtsUReIS9itHDRdHBEMg/viewform?embedded=true";
const SIGNUP_FORM_URL = "https://docs.google.com/forms/d/e/1FAIpQLSdix2-jvF-Fr7OK0S7A514oTVXjQgmgWp4CvPUm9pEg8Y_x6w/viewform?embedded=true";

const WA_NUMBER = "918397985922"; 
const UPI_ID = "8397985922@ptsbi"; 

let tempSelection = [], bookingQueue = [], currentQueueIndex = 0, masterBookingData = {}, currentUser = null, patientsDB = {}, partnersDB = {}, usePoints = false, activeCoupon = null, selectedPatientName = "", currentSessionAddress = ""; 
partnersDB['8397985922'] = { pass: '8397985922', name: 'Master Partner' };
const discountMap = { basic: 0.20, gold: 0.35, platinum: 0.50, pkg_basic: 0.10, pkg_gold: 0.20, pkg_platinum: 0.30 };

const centerAddressDB = {
    "Shree Diagnostic": "Metro Pillar No-862, Khasra no. 2444,venus plaza nehru Enclave, Rohtak Rd, Bahadurgarh, Haryana 124507",
    "Shree": "Metro Pillar No-862, Khasra no. 2444,venus plaza nehru Enclave, Rohtak Rd, Bahadurgarh, Haryana 124507",
    "Ved Hospital": "MWM8+9XR, Main, Jhajjar Rd, Huda Nahar, Bahadurgarh, Haryana 124507",
    "Ved": "MWM8+9XR, Main, Jhajjar Rd, Huda Nahar, Bahadurgarh, Haryana 124507",
    "Default": "Metro Pillar No-862, Khasra no. 2444,venus plaza nehru Enclave, Rohtak Rd, Bahadurgarh, Haryana 124507" 
};

window.onload = function(){ loadGoogleSheetData(); loadPatientData(); loadPartnerData(); };

/* DATA LOADERS */
async function loadGoogleSheetData() {
    const msg = document.getElementById("loadingMsg");
    try {
        let res = await fetch(RAW_SHEET_URL);
        if(!res.ok) res = await fetch(RATE_SHEET_URL); 
        const text = await res.text();
        parseProducts(text);
        refreshPrices('basic'); 
    } catch(e) { msg.innerHTML = "Error loading tests.<br>Check connection."; msg.style.color="red"; }
}

async function loadPatientData() {
    try {
        let res = await fetch(RAW_PATIENT_URL);
        if(!res.ok) res = await fetch(PATIENT_SHEET_URL);
        const text = await res.text();
        parsePatients(text);
    } catch(e) {}
}

async function loadPartnerData() {
    try {
        let res = await fetch(RAW_PARTNER_DB_URL);
        if(!res.ok) res = await fetch(PARTNER_DB_URL);
        const text = await res.text();
        parsePartners(text);
    } catch(e) {}
}

function parsePartners(csv) {
    const rows = csv.split('\n').slice(1);
    rows.forEach(row => {
        const cols = row.split(',').map(c=>c.replace(/"/g,'').trim());
        if(cols.length >= 2) {
            partnersDB[cols[0].toUpperCase()] = { pass: cols[1], name: cols[2] || "Partner" };
        }
    });
}

function parsePatients(csvText) { 
    const rows = csvText.split('\n'); 
    rows.slice(1).forEach(row => { 
        if(!row.trim()) return;
        const cols = [];
        let col = "";
        let quotes = false;
        for(let i=0; i<row.length; i++){
            if(row[i] === '"') { quotes = !quotes; continue; }
            if(row[i] === ',' && !quotes) { cols.push(col.trim()); col = ""; }
            else { col += row[i]; }
        }
        cols.push(col.trim());

        if(cols.length < 3) return; 
        const mob = cols[2]; 
        if(mob && mob.length >= 10) { 
            let plan = cols[5] && cols[5].length > 2 ? cols[5] : 'Basic'; 
            let points = parseInt(cols[6]) || 0; 
            let familyMembers = [];
            if(cols[7] && cols[7].trim()) familyMembers.push(cols[7].trim());
            if(cols[8] && cols[8].trim()) familyMembers.push(cols[8].trim());
            if(cols[9] && cols[9].trim()) familyMembers.push(cols[9].trim());

            patientsDB[mob] = { 
                mobile: mob, 
                name: cols[1], 
                password: cols[3], 
                address: cols[4]||"", 
                plan: plan, 
                points: points, 
                reports: [], 
                referral: cols[1].split(" ")[0].toUpperCase()+mob.slice(-3), 
                family: familyMembers 
            }; 
        } 
    }); 
}

function parseProducts(csvText) { 
    const rows = [];
    let currentRow = "";
    let insideQuotes = false;
    for (let i = 0; i < csvText.length; i++) {
        const char = csvText[i];
        if (char === '"') insideQuotes = !insideQuotes;
        if (char === '\n' && !insideQuotes) { rows.push(currentRow); currentRow = ""; } else { currentRow += char; }
    }
    if (currentRow) rows.push(currentRow);

    rows.slice(1).forEach(row => { 
        if(!row.trim()) return;
        const cols = [];
        let col = "";
        let quotes = false;
        for(let i=0; i<row.length; i++){
            if(row[i] === '"') { quotes = !quotes; continue; }
            if(row[i] === ',' && !quotes) { cols.push(col.trim()); col = ""; }
            else { col += row[i]; }
        }
        cols.push(col.trim());

        if(cols.length < 3) return; 
        
        let cat = cols[2].toLowerCase();
        if(cat.includes('blood') || cat.includes('test') || cat.includes('pathology') || cat.includes('lab')) cat = 'test';
        else if(cat.includes('sound') || cat.includes('usg')) cat = 'usg';
        else if(cat.includes('x-ray') || cat.includes('x ray') || cat.includes('xray')) cat = 'xray';
        else if(cat.includes('ct scan') || cat === 'scan' || cat === 'ct') cat = 'ct';
        else if(cat.includes('mri')) cat = 'mri';
        else if(cat.includes('doctor') || cat.includes('dr')) cat = 'doctor';
        else if(cat.includes('package') || cat.includes('checkup')) cat = 'package';
        else if(cat.includes('ecg')) cat = 'ecg';
        else if(cat.includes('echo')) cat = 'echo';
        
        let cleanPrice = cols[1].replace(/[^0-9]/g, '');
        createCard({ 
            name: cols[0].replace(/"/g, ''), 
            price: parseInt(cleanPrice) || 0, 
            category: cat, 
            discount: cols[3] && cols[3].toLowerCase() === 'yes', 
            image: cols[4]||"", 
            details: cols[5]||"" 
        }); 
    }); 
    
    if(document.querySelectorAll('.card, .doc-card, .pkg-card').length > 0) {
        document.getElementById("loadingMsg").style.display = 'none';
    } else {
        document.getElementById("loadingMsg").innerHTML = "No tests found.<br>Check Sheet.";
    }
}

/* UI FUNCTIONS */
function openMenu() { document.getElementById("sidebar").classList.add("open"); document.getElementById("sidebarOverlay").style.display = "block"; }
function closeMenu() { document.getElementById("sidebar").classList.remove("open"); document.getElementById("sidebarOverlay").style.display = "none"; }
function shareApp() { const msg = `Book Blood Tests & Doctors on Bhavya Diagnostics App! Link: https://dharmender.github.io/diagnostic-app`; window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`, "_blank"); }

function show(id, btn){ 
    document.querySelectorAll('.section').forEach(s => s.classList.remove('active')); 
    document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active')); 
    document.getElementById(id).classList.add('active'); 
    if(btn) btn.classList.add('active'); 
}

function startBookingQueue() {
    if(tempSelection.length === 0) return;
    currentSessionAddress = currentUser ? currentUser.address : ""; 
    const categories = [...new Set(tempSelection.map(item => item.type))];
    bookingQueue = [];
    if(categories.includes('test')) bookingQueue.push('test');
    if(categories.includes('package')) bookingQueue.push('package');
    const centerServices = ['usg', 'xray', 'ct', 'mri', 'ecg', 'echo', 'doctor'];
    centerServices.forEach(s => { if(categories.includes(s)) bookingQueue.push(s); });
    currentQueueIndex = 0;
    masterBookingData = {}; 
    renderQueueStep();
}

function renderQueueStep() {
    const type = bookingQueue[currentQueueIndex];
    if(!type) { closeAllPopups(); toggleMainCart(); return; }
    document.getElementById("overlay").style.display = "block";
    const modal = document.getElementById("stepModal");
    modal.style.display = "flex";
    document.getElementById("stepTitle").innerText = { 'test': 'ü©∏ Blood Test', 'package': 'üì¶ Package', 'usg': 'üñ•Ô∏è USG', 'xray': 'ü¶¥ X-Ray', 'ct': 'üß† CT Scan', 'ecg': 'üíì ECG', 'echo': 'ü´Ä ECHO', 'doctor': 'üë®‚öïÔ∏è Doctor' }[type] || 'Booking Details';
    document.getElementById("stepSubtitle").innerText = `Step ${currentQueueIndex + 1} of ${bookingQueue.length}`;
    const prefillName = selectedPatientName || (currentUser ? currentUser.name : "");
    const today = new Date().getDay(); 
    let timeHtml = "";
    
    if(type === 'ecg') {
        for(let i=0; i<24; i++) {
            let hr = i > 12 ? i - 12 : (i===0 ? 12 : i);
            let ampm = i >= 12 ? "PM" : "AM";
            timeHtml += `<div class="time-slot" onclick="selectTime(this)">${hr}:00 ${ampm}</div>`;
        }
    } else {
        let start = 7, end = 20; 
        if(['usg','xray','ct','mri','echo'].includes(type)) {
            start = 9; 
            end = (today === 0) ? 14 : 18; 
        }
        for(let i=start; i<=end; i++) {
            let hr = i > 12 ? i - 12 : i;
            let ampm = i >= 12 ? "PM" : "AM";
            timeHtml += `<div class="time-slot" onclick="selectTime(this)">${hr}:00 ${ampm}</div>`;
        }
    }

    let html = '';
    let patientInputHtml = '';
    if(currentUser) {
        patientInputHtml = `<select id="qName" class="med-input" style="font-weight:bold; background:#e3f2fd; color:#0a73c0; border:1px solid #0a73c0;">`;
        patientInputHtml += `<option value="${currentUser.name}">üë§ ${currentUser.name} (Self)</option>`;
        if(currentUser.family && currentUser.family.length > 0) {
            currentUser.family.forEach(f => {
                if(f) patientInputHtml += `<option value="${f}">üë• ${f}</option>`;
            });
        }
        patientInputHtml += `</select>`;
    } else {
        patientInputHtml = `<input id="qName" class="med-input" placeholder="Patient Name" value="${prefillName}">`;
    }

    if(type === 'test' || type === 'package') {
        html += `<span class="booking-label">Select Lab</span><div class="option-group"><div class="option-btn selected" onclick="selectOpt(this,'lab','Wellness')">Wellness</div><div class="option-btn" onclick="selectOpt(this,'lab','CRL')">CRL</div><div class="option-btn" onclick="selectOpt(this,'lab','Accuprobe')">Accuprobe</div></div><span class="booking-label">Location</span><div class="option-group"><div class="option-btn selected" onclick="toggleAddress(true); selectOpt(this,'mode','Home')">Home</div><div class="option-btn" onclick="toggleAddress(false); selectOpt(this,'mode','Center')">Center</div></div>`;
    } else if (['usg', 'xray', 'ct', 'mri', 'echo'].includes(type)) {
        html += `<span class="booking-label">Center</span><div class="option-group"><div class="option-btn selected" onclick="selectOpt(this,'center','Shree Diagnostic')"><div style="font-size:8px; color:#d32f2f; font-weight:bold; letter-spacing:0.5px;">NABH ACCREDITED</div>Shree Diagnostic</div></div>`;
    } else if (type === 'ecg') {
        html += `<span class="booking-label">Select Center</span><div class="option-group"><div class="option-btn selected" onclick="selectOpt(this,'center','Shree Diagnostic')"><div style="font-size:8px; color:#d32f2f; font-weight:bold; letter-spacing:0.5px;">NABH ACCREDITED</div>Shree Diagnostic</div><div class="option-btn" onclick="selectOpt(this,'center','Ved Hospital')">Ved Hospital</div></div>`;
    }
    
    html += `<span class="booking-label">Patient</span>${patientInputHtml}<div id="qAddressBox"><span class="booking-label">Address</span><select id="qCity" class="med-input"><option selected>Bahadurgarh</option><option>Jhajjar</option><option>Rohtak</option></select><textarea id="qAddr" class="med-input" rows="2" placeholder="Address">${currentSessionAddress}</textarea></div><span class="booking-label">Time</span><input type="date" id="qDate" class="med-input" value="${new Date().toISOString().split('T')[0]}"><div class="time-grid" id="qTimeSlots">${timeHtml}</div>`;
    document.getElementById("dynamicFormBody").innerHTML = html;
    document.getElementById("stepModal").dataset.currentType = type;
}

function nextQueueStep() {
    const type = document.getElementById("stepModal").dataset.currentType;
    const name = document.getElementById("qName").value;
    const date = document.getElementById("qDate").value;
    const timeEl = document.querySelector(".time-slot.selected");
    if(!name || !date || !timeEl) { showAlert("Fill Name & Time"); return; }
    
    const addrInput = document.getElementById("qAddr");
    if(addrInput && addrInput.value) { currentSessionAddress = addrInput.value; }

    let details = { name, date, time: timeEl.innerText, city: document.getElementById("qCity")?.value || "N/A", address: currentSessionAddress || "N/A" };
    
    if(type === 'test' || type === 'package') {
        details.lab = document.querySelector(".option-btn[onclick*='lab'].selected")?.innerText || "Wellness";
        details.mode = document.querySelector(".option-btn[onclick*='mode'].selected")?.innerText || "Home";
    } else if (['usg', 'xray', 'ct', 'mri', 'echo', 'ecg'].includes(type)) {
        details.center = document.querySelector(".option-btn[onclick*='center'].selected")?.innerText.replace("NABH ACCREDITED", "").trim() || "Shree Diagnostic";
        details.mode = "Center";
    }
    
    masterBookingData[type] = details;
    currentQueueIndex++;
    renderQueueStep();
}

function toggleMainCart() {
    document.getElementById("overlay").style.display="block"; 
    document.getElementById("mainCartBox").style.display="flex";
    let html = "", grandTotal = 0, discountableTotal = 0, totalMRP = 0;
    
    const currentPlan = document.querySelector('.plan.active') ? document.querySelector('.plan.active').dataset.plan : 'basic';
    const testDisc = discountMap[currentPlan];
    const centerDisc = (currentPlan === 'platinum') ? 0.20 : (currentPlan === 'gold' ? 0.10 : 0.05);

    [...new Set(tempSelection.map(item => item.type))].forEach(cat => {
        const items = tempSelection.filter(i => i.type === cat);
        const booking = masterBookingData[cat];
        if(items.length > 0) {
            html += `<div class="cart-group-header">${cat.toUpperCase()} ${booking ? `(${booking.mode||booking.center||booking.lab})` : ''}</div>`;
            items.forEach(i => {
                let discount = (cat==='test' || cat==='package') ? testDisc : centerDisc;
                if(cat==='package') discount = discountMap['pkg_'+currentPlan];
                let finalPrice = Math.round(i.price - (i.price * discount));
                let totalFinal = finalPrice * i.qty;
                let totalOriginal = i.price * i.qty;
              
                grandTotal += totalFinal;
                totalMRP += totalOriginal;
                if(cat === 'test' || cat === 'package') {
                   discountableTotal += totalFinal;
                }

                html += `<div class="cart-item-row">
                    <span class="remove-item-btn" onclick="removeItemFromCart('${i.name}')">‚ùå</span>
                    <span style="flex:1">${i.name} x${i.qty}</span>
                    <span><s style="font-size:10px;color:#999;margin-right:5px">‚Çπ${totalOriginal}</s> <b>‚Çπ${totalFinal}</b></span>
                </div>`;
              
                if(i.contrast) { 
                    let cp = 3000 * i.qty; 
                    grandTotal += cp; 
                    totalMRP += cp;
                    html += `<div class="cart-item-row" style="color:#d32f2f; font-size:11px;"><span></span><span>+ Contrast</span><span>‚Çπ${cp}</span></div>`; 
                }
            });
            if(booking) {
                let displayAddr = "";
                if ((cat === 'test' || cat === 'package')) {
                    displayAddr = booking.mode === 'Home' ? `${booking.address}, ${booking.city}` : centerAddressDB["Ved"];
                } else {
                    displayAddr = centerAddressDB[booking.center] || centerAddressDB["Default"];
                }
                html += `<div class="cart-details-row">üë§ ${booking.name} | üìÖ ${booking.date}, ${booking.time}</div>`;
                html += `<div class="cart-details-row" style="color:#666;">üìç ${displayAddr}</div>`;
            }
        }
    });

    let walletPointsUsed = 0;
    let extraDiscount = 0;
    if(activeCoupon && discountableTotal > 50) {
        extraDiscount += 50;
        document.getElementById("couponMsg").innerText = `Referral Applied (${activeCoupon}): ‚Çπ50 OFF`;
        document.getElementById("couponMsg").style.color = "green";
    } else if (!activeCoupon) {
        document.getElementById("couponMsg").innerText = "";
    }

    if(currentUser && usePoints) {
        let pointValue = Math.floor(currentUser.points / 10);
        walletPointsUsed = Math.min(pointValue, (discountableTotal - extraDiscount));
        extraDiscount += walletPointsUsed;
        document.getElementById("discountVal").innerText = extraDiscount;
        document.getElementById("availPoints").innerText = currentUser.points;
    } else {
        document.getElementById("discountVal").innerText = extraDiscount;
    }

    document.getElementById("finalCartItems").innerHTML = html;
    let finalPay = grandTotal - extraDiscount;
    document.getElementById("payAmount").innerText = finalPay > 0 ? finalPay : 0;
    document.getElementById("redeemBox").style.display = (currentUser && currentUser.points >= 10) ? "flex" : "none";
}

function removeItemFromCart(name) {
    tempSelection = tempSelection.filter(i => i.name !== name);
    // UI mein bhi card ko reset karna padega
    document.querySelectorAll('.card, .pkg-card').forEach(c => {
        if(c.dataset.name === name) {
            const w = c.querySelector('.qty-wrapper');
            w.querySelector('.add-btn').style.display = 'block';
            w.querySelector('.qty-control').style.display = 'none';
            c.classList.remove('selected');
        }
    });
    updateGlobalCount();
    if(tempSelection.length === 0) {
        closeAllPopups();
    } else {
        toggleMainCart();
    }
}

function updateGlobalCount() {
    let count = tempSelection.reduce((s,i) => s + i.qty, 0); 
    document.getElementById("finalCount").innerText = count; 
    const tBtn = document.getElementById("topProceedBtn"); 
    if(count > 0) { tBtn.innerText = `Proceed (${count}) ‚ûî`; tBtn.classList.add("active"); tBtn.disabled = false; } 
    else { tBtn.innerText = "Cart Empty"; tBtn.classList.remove("active"); tBtn.disabled = true; } 
}

function updateQty(btn, change) { 
    const m = document.getElementById("mobile").value; 
    if(m.length!==10){ showAlert("Enter Mobile"); return; } 
    const card = btn.closest('.card') || btn.closest('.pkg-card'); 
    const name = card.dataset.name; 
    const type = card.dataset.type; 
    const price = parseInt(card.dataset.price); 
    const contrastChk = card.querySelector('.contrast-box input');
    const hasContrast = contrastChk ? contrastChk.checked : false;
    let item = tempSelection.find(i => i.name === name); 
    if(item) { item.qty += change; if(change > 0 && hasContrast) item.contrast = true; if(item.qty <= 0) tempSelection = tempSelection.filter(i => i.name !== name); } 
    else if(change > 0) { tempSelection.push({ name, price, type, qty: 1, contrast: hasContrast }); } 
    const w = card.querySelector('.qty-wrapper'); 
    if(change > 0 || (item && item.qty > 0)) { w.querySelector('.add-btn').style.display = 'none'; w.querySelector('.qty-control').style.display = 'flex'; w.querySelector('span').innerText = item ? item.qty : 1; card.classList.add('selected'); } 
    else { w.querySelector('.add-btn').style.display = 'block'; w.querySelector('.qty-control').style.display = 'none'; card.classList.remove('selected'); if(contrastChk) contrastChk.checked = false; } 
    updateGlobalCount();
}

function handleMyInfoClick(){ 
    if(currentUser){ 
        document.getElementById("overlay").style.display="block"; 
        document.getElementById("infoModal").style.display="block";
    } else { 
        document.getElementById("overlay").style.display="block"; 
        document.getElementById("loginModal").style.display="block";
    } 
}

function checkLogin() { 
    const u = patientsDB[document.getElementById("loginMob").value]; 
    if(u && u.password === document.getElementById("loginPass").value) { 
        currentUser=u; 
        document.getElementById("btnMyInfo").innerText="üë§ "+u.name.split(" ")[0]; 
        document.getElementById("btnMyInfo").classList.add("logged-in"); 
        document.getElementById("dashPoints").innerText = u.points; 
        document.getElementById("dashPlan").innerText = u.plan; 
        document.getElementById("dashRef").innerText = u.referral; 
        document.getElementById("dashPlan").className = "dash-val highlight-plan"; 
        document.getElementById("dashboardSection").style.display = "block"; 
        document.getElementById("availPoints").innerText = u.points;
        const mobInput = document.getElementById("mobile");
        mobInput.value = u.mobile; 
        selectedPatientName = u.name;
        const famCon = document.getElementById("dashFamilyContainer");
        let html = `<div class="dash-fam-btn active" onclick="selectedPatientName='${u.name}'">${u.name.split(" ")[0]}</div>`;
        if(u.family && u.family.length > 0) { 
            u.family.forEach(f => { 
                if(f) html += `<div class="dash-fam-btn" onclick="selectedPatientName='${f}'">${f}</div>`; 
            }); 
        }
        html += `<div class="dash-fam-btn dash-fam-add" onclick="openFormModal(SIGNUP_FORM_URL, 'Add Member')">+ Add</div>`;
        famCon.innerHTML = html;
        
        const p = u.plan ? u.plan.toLowerCase() : 'basic'; 
        const bG = document.getElementById("topBannerGold"), bP = document.getElementById("topBannerPlat"), vB = document.getElementById("topVipBadge"); 
        bG.style.display="flex"; bP.style.display="flex"; vB.style.display="none"; 
        if(p==='gold'){ 
            bG.style.display="none"; 
            vB.style.display="block"; 
            vB.innerText = "üëë YOU ARE A GOLD MEMBER";
        } else if(p==='platinum'){ 
            bG.style.display="none"; 
            bP.style.display="none"; 
            vB.style.display="block"; 
            vB.innerText = "üëë YOU ARE A PLATINUM MEMBER";
        }
        
        fetchHistory(u.mobile);
        closeAllPopups(); 
        applyPlanByMobile(); 
    } else showAlert("Invalid Credentials"); 
}

function applyPlanByMobile() {
    const m = document.getElementById("mobile").value;
    const status = document.getElementById("planStatus");
    if (m.length === 10) {
        if (patientsDB[m]) {
            let plan = patientsDB[m].plan.toLowerCase();
            status.innerText = "‚úÖ " + plan.toUpperCase() + " APPLIED";
            status.className = "plan-badge-status active";
            refreshPrices(plan);
            document.querySelectorAll('.plan').forEach(p => {
                if (p.dataset.plan !== plan) p.classList.add('locked');
                else p.classList.remove('locked');
            });
        } else {
            status.innerText = "üë§ New User (Basic)";
            status.className = "plan-badge-status";
            refreshPrices('basic');
            document.querySelectorAll('.plan').forEach(p => p.classList.remove('locked'));
        }
    } else {
        status.innerText = "Pending";
        status.className = "plan-badge-status";
    }
}

function createCard(item) { 
    if (item.category === 'doctor') { const div = document.createElement('div'); div.className = 'doc-card'; div.dataset.price = item.price; div.dataset.type = 'doctor'; div.innerHTML = `<img src="${item.image || 'https://via.placeholder.com/60'}" class="doc-img"><div class="doc-info"><div class="doc-name">${item.name}</div><div class="doc-deg">${item.details}</div><div class="doc-fee">‚Çπ<span class="final-price"><b>${item.price}</b></span></div></div><button class="book-btn" onclick="bookDoctor('${item.name}', ${item.price}, this)">Book</button>`; document.getElementById("docContainer").appendChild(div); return; } 
    if (item.category === 'package') { const div = document.createElement('div'); div.className = 'pkg-card'; div.dataset.name = item.name; div.dataset.price = item.price; div.dataset.type = 'package'; let badge = ""; if(item.details.toLowerCase().includes("gold")) badge = `<div class="unlock-badge">üèÜ UNLOCKS GOLD</div>`; if(item.details.toLowerCase().includes("platinum")) badge = `<div class="unlock-badge platinum-badge">üíé UNLOCKS PLATINUM</div>`; div.innerHTML = `${badge}<div class="pkg-header"><div class="pkg-name">${item.name}</div></div><div class="pkg-body"><span class="mrp-price">‚Çπ${item.price}</span><span class="pkg-rate">‚Çπ<b>${item.price}</b></span><button class="view-details-btn" onclick="showIncludedTests('${item.name}', '${item.details.replace(/'/g, "\\'")}')">‚ÑπÔ∏è View Details</button></div><div class="pkg-footer"><div class="qty-wrapper"><button class="add-btn" onclick="updateQty(this, 1)">Add</button><div class="qty-control"><button onclick="updateQty(this, -1)">-</button><span>0</span><button onclick="updateQty(this, 1)">+</button></div></div></div>`; document.getElementById("pkgGrid").appendChild(div); return; } 
    let container = document.getElementById(item.category); if (!container && item.category === 'test') container = document.getElementById("test"); if (!container && item.category === 'usg') container = document.getElementById("usgContainer"); if (!container && item.category === 'xray') container = document.getElementById("xrayContainer"); if (!container && item.category === 'ct') container = document.getElementById("ctContainer"); if (!container && item.category === 'mri') container = document.getElementById("mriContainer"); if (!container && item.category === 'ecg') container = document.getElementById("ecgContainer"); if (!container && item.category === 'echo') container = document.getElementById("echoContainer"); 
    if (container) { 
        if(container.id.includes('Container') === false && item.category !== 'test') { let innerCon = container.querySelector('[id$="Container"]'); if(innerCon) container = innerCon; } 
        const div = document.createElement('div'); div.className = 'card'; div.dataset.name = item.name; div.dataset.price = item.price; div.dataset.type = item.category; 
        let contrastHtml = ""; if(item.category === 'ct' || item.category === 'mri') contrastHtml = `<label class="contrast-box"><input type="checkbox"> üíä + Contrast (‚Çπ3000)</label>`;
        div.innerHTML = `<div><div class="card-info">${item.name}</div><div class="card-price-box"><span class="mrp-price">‚Çπ${item.price}</span><span class="final-price">‚Çπ<b>${item.price}</b></span></div></div><div class="qty-wrapper">${contrastHtml}<button class="add-btn" onclick="updateQty(this, 1)">ADD +</button><div class="qty-control"><button onclick="updateQty(this, -1)">-</button><span>0</span><button onclick="updateQty(this, 1)">+</button></div></div>`; container.appendChild(div); 
    } 
}

function refreshPrices(plan){ 
    document.querySelectorAll('.plan').forEach(p=>{p.classList.remove('active');if(p.dataset.plan===plan)p.classList.add('active');}); 
    const testDisc = discountMap[plan];
    const centerDisc = (plan==='platinum')?0.20 : (plan==='gold'?0.10:0.05);
    document.querySelectorAll('.card,.pkg-card').forEach(c=>{
        const op = parseInt(c.dataset.price); 
        const t = c.dataset.type; 
        let d = (t==='test' || t==='package') ? testDisc : centerDisc;
        if(t==='package') d = discountMap['pkg_'+plan];
        let final = Math.round(op - (op*d));
        c.querySelector('.final-price b,.pkg-rate b').innerText="‚Çπ"+final;
    }); 
    document.querySelectorAll('.doc-card').forEach(c=>{ 
        const op = parseInt(c.dataset.price); 
        let d = (plan==='platinum'?0.20 : (plan==='gold'?0.10 : 0.05)); 
        let final = Math.round(op - (op*d));
        c.querySelector('.doc-fee').innerHTML = `<span style="text-decoration:line-through;color:#999;font-size:11px;">‚Çπ${op}</span> ‚Çπ<span class="final-price"><b>${final}</b></span>`;
    }); 
    if(document.getElementById("mainCartBox").style.display === 'flex') {
        toggleMainCart();
    }
}

function filter(i,id){ let v=i.value.toLowerCase(); document.querySelectorAll(`#${id} .card`).forEach(c=>c.style.display=c.innerText.toLowerCase().includes(v)?'flex':'none'); }
function filterDocs(i){ let v=i.value.toLowerCase(); document.querySelectorAll('.doc-card').forEach(c=>c.style.display=c.innerText.toLowerCase().includes(v)?'flex':'none'); }

function applyCoupon(){ 
    const input = document.getElementById("couponCode");
    const btn = document.querySelector(".coupon-section button");
    const msg = document.getElementById("couponMsg");
    if(activeCoupon) {
        activeCoupon = null;
        input.value = "";
        input.disabled = false;
        btn.innerText = "APPLY";
        btn.style.background = "#333";
        msg.innerText = "Referral Code Removed";
        msg.style.color = "orange";
        toggleMainCart();
        return;
    }
    const val = input.value.trim().toUpperCase();
    if(val === "") { showAlert("Enter a referral code"); return; }
    let isValidCode = false;
    for (let mob in patientsDB) {
        if (patientsDB[mob].referral === val) {
            if (currentUser && currentUser.referral === val) {
                msg.innerText = "Cannot use your own code!";
                msg.style.color = "red";
                return;
            }
            isValidCode = true;
            break;
        }
    }
    if(isValidCode){ 
        activeCoupon = val;
        input.disabled = true;
        btn.innerText = "REMOVE";
        btn.style.background = "#d32f2f"; 
        msg.innerText = `Referral Applied: ‚Çπ50 OFF`;
        msg.style.color = "green";
        toggleMainCart(); 
    } else {
        activeCoupon = null;
        msg.innerText = "Invalid referral code!";
        msg.style.color = "red";
        toggleMainCart();
    }
}

function togglePointUsage(){ usePoints=document.getElementById("pointCheck").checked; toggleMainCart(); }
function logoutUser(){ location.reload(); }
function bookDoctor(n,p,btn){ const c=btn.closest('.doc-card'); const dp=parseInt(c.querySelector('.final-price b').innerText.replace('‚Çπ','')); if(confirm(`Book ${n} for ‚Çπ${dp}?`)) window.open(`https://wa.me/${WA_NUMBER}?text=${encodeURIComponent(`Doctor: ${n}, Fee: ${dp}`)}`,"_blank"); }
function showIncludedTests(t,d){ document.getElementById("detailsTitle").innerText=t; const l=document.getElementById("detailsList"); l.innerHTML=""; d.split(',').forEach(i=>{if(i.trim()){const x=document.createElement("li"); x.innerText=i.trim(); l.appendChild(x);}}); document.getElementById("overlay").style.display="block"; document.getElementById("detailsModal").style.display="block"; }
function openFormModal(url, title) { document.querySelectorAll('.popup-box').forEach(b => b.style.display = "none"); document.getElementById("overlay").style.display = "block"; const modal = document.getElementById("universalFormModal"); modal.style.display = "flex"; document.getElementById("formTitle").innerText = title; document.getElementById("formFrame").src = url; }
function openPartnerModal() { document.getElementById("overlay").style.display = "block"; document.getElementById("partnerModal").style.display = "block"; }

function sendMedRequest(){ 
    const m=document.getElementById("mobile").value; 
    if(m.length!==10){showAlert("Enter Mobile");return;} 
    window.open(`https://wa.me/${WA_NUMBER}?text=${encodeURIComponent(`üìã *Prescription Upload*\nMobile: ${m}\n\n*upload your doctor prescription now...*`)}`,"_blank"); 
}

function sendHospRequest(){ window.open(`https://wa.me/${WA_NUMBER}?text=${encodeURIComponent(`üè• *Hospital Lead*\nMobile: ${document.getElementById("mobile").value}\nReason: ${document.getElementById("admReason").value}\nPay: ${document.getElementById("admPay").value}`)}`,"_blank"); }
function sendForgotPassReq(){ const m=document.getElementById("loginMob").value; const p=document.getElementById("newPassInput").value; if(m.length<10){showAlert("Enter Mobile first");return;} if(!p){showAlert("Enter New Pass");return;} window.open(`https://wa.me/${WA_NUMBER}?text=${encodeURIComponent(`Hey Bhavya Diagnostics, Reset Pass\nMob: ${m}\nNew Pass: ${p}`)}`,"_blank"); closeAllPopups(); }

function clearMainCart(){ 
    tempSelection=[]; 
    // UI cards reset
    document.querySelectorAll('.card, .pkg-card').forEach(c => {
        const w = c.querySelector('.qty-wrapper');
        if(w) {
            w.querySelector('.add-btn').style.display = 'block';
            w.querySelector('.qty-control').style.display = 'none';
            c.classList.remove('selected');
        }
    });
    updateGlobalCount();
    closeAllPopups();
}

function payOnline() { const amt = document.getElementById("payAmount").innerText; if(amt == 0) return; window.location.href = `upi://pay?pa=${UPI_ID}&pn=BhavyaDiagnostics&am=${amt}&cu=INR`; }

function bookWithPayment(){ 
    const id = "B-" + Math.floor(10000 + Math.random() * 90000); 
    const amt = document.getElementById("payAmount").innerText; 
    let msg = `üåü *New Booking Request*\n`; 
    msg += `üÜî ID: ${id}\n`;
    msg += `üë§ Patient: ${document.getElementById("qName").value}\n`;
    msg += `üì± Mobile: ${document.getElementById("mobile").value}\n`;
    msg += `------------------\n`;
    
    let totalMRP = 0;
    let totalDiscount = 0;
    const currentPlan = document.querySelector('.plan.active').dataset.plan;
    const testDisc = discountMap[currentPlan];
    const centerDisc = (currentPlan === 'platinum') ? 0.20 : (currentPlan === 'gold' ? 0.10 : 0.05);

    Object.keys(masterBookingData).forEach(cat => { 
        let d = masterBookingData[cat]; 
        let items = tempSelection.filter(i => i.type === cat); 
        let locationName = d.lab || d.center || "Bhavya Diagnostics";
        let finalAddress = (cat === 'test' || cat === 'package') ? (d.mode === 'Home' ? `${d.address}, ${d.city}` : centerAddressDB["Ved"]) : (centerAddressDB[locationName] || centerAddressDB["Default"]);
        
        msg += `üìå *${cat.toUpperCase()}*\n`;
        msg += `üè¢ Center: ${locationName} (${d.mode})\n`;
        msg += `üìÖ Schedule: ${d.date} | üïí ${d.time}\n`;
        msg += `üìç Addr: ${finalAddress}\n`;
        
        items.forEach((i, idx) => { 
            let discount = (cat === 'test' || cat === 'package') ? testDisc : centerDisc;
            if(cat === 'package') discount = discountMap['pkg_' + currentPlan];
            let finalPrice = Math.round(i.price - (i.price * discount));
            let itemMRP = i.price;
            
            totalMRP += (itemMRP * i.qty);
            msg += `${idx + 1}. ${i.name} x${i.qty}\n`;
            msg += `   Rate: ‚Çπ${finalPrice} (MRP: ‚Çπ${itemMRP})\n`;
            
            if(i.contrast) {
                msg += `   (+ Contrast: ‚Çπ3000)\n`;
                totalMRP += 3000;
            }
        });
        msg += `------------------\n`;
    }); 

    // Final calculations for message
    let walletUsed = 0;
    let couponOff = activeCoupon ? 50 : 0;
    
    if(usePoints && currentUser) {
        let pointVal = Math.floor(currentUser.points / 10);
        walletUsed = Math.min(pointVal, (amt - couponOff)); // Approximate
    }

    msg += `üí∞ *Bill Summary:*\n`;
    msg += `Total MRP: ‚Çπ${totalMRP}\n`;
    if(totalMRP - amt > 0) msg += `Total Discount: ‚Çπ${Math.round(totalMRP - amt)}\n`;
    if(activeCoupon) msg += `üéüÔ∏è Referral (${activeCoupon}): -‚Çπ50\n`;
    if(usePoints) msg += `Points Redeemed: Yes\n`;
    msg += `\n‚úÖ *Final Payable: ‚Çπ${amt}*`;
    
    window.open(`https://wa.me/${WA_NUMBER}?text=${encodeURIComponent(msg)}`, "_blank"); 
    closeAllPopups(); 
    clearMainCart(); 
}

function verifyPartner() { const id = document.getElementById("partnerId").value.toUpperCase().trim(); const pass = document.getElementById("partnerPass").value.trim(); if (partnersDB[id] && partnersDB[id].pass === pass) { document.getElementById("partnerLoginForm").style.display = "none"; document.getElementById("partnerCancelBtn").style.display = "none"; document.getElementById("partnerDashboard").style.display = "block"; document.getElementById("partnerWelcomeMsg").innerHTML = `Welcome, <b>${partnersDB[id].name}</b>`; } else { showAlert("‚ùå Wrong ID or Password!"); } }
function shareReferral() { const code = document.getElementById("dashRef").innerText; const msg = `Hey! Use my code *${code}* on Bhavya Diagnostics to get discounts on Blood Tests.`; window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`, "_blank"); }
function toggleAddress(show) { const b = document.getElementById("qAddressBox"); if(b) b.style.display = show?"block":"none"; }
function selectOpt(btn, grp, val) { btn.parentElement.querySelectorAll('.option-btn').forEach(s => s.classList.remove('selected')); btn.classList.add('selected'); }
function selectTime(el){ document.querySelectorAll('.time-slot').forEach(t=>t.classList.remove('selected')); el.classList.add('selected'); }
function closeAllPopups(){ document.querySelectorAll('.popup-box').forEach(b=>b.style.display="none"); document.getElementById("overlay").style.display="none"; document.getElementById("customAlert").style.display="none"; }
function showAlert(msg) { document.getElementById("customAlertMsg").innerText = msg; document.getElementById("overlay").style.display = "block"; document.getElementById("customAlert").style.display = "block"; }
function closeCustomAlert() { document.getElementById("customAlert").style.display = "none"; if(document.querySelectorAll('.popup-box[style*="display: block"], .popup-box[style*="display: flex"]').length === 0) document.getElementById("overlay").style.display = "none"; }

/* üìú HISTORY & REPORT LOGIC (Manual Sheet Support) */
async function fetchHistory(mob) {
    const histCon = document.getElementById("notifyContainer");
    const repCon = document.getElementById("reportContainer");
    histCon.innerHTML = '<div style="text-align:center;padding:10px;color:#999;">Loading...</div>';
    repCon.innerHTML = '<div style="text-align:center;padding:10px;color:#999;">Checking...</div>';
    try {
        let res = await fetch(RAW_HISTORY_URL);
        if(!res.ok) res = await fetch(HISTORY_DATA_URL);
        const csvText = await res.text();
        const rows = csvText.split('\n').slice(1); 
        let histHtml = "", repHtml = "", foundHist = false, foundRep = false;
        rows.forEach(row => {
            const cols = row.split(',').map(c => c.replace(/"/g, '').trim());
            if (cols[2] === mob) {
                foundHist = true;
                const rowDate = cols[0], rowMsg = cols[1], rowType = cols[3] || "TEST", rowLink = cols[4] || "";
                histHtml += `<div class="list-item"><div style="flex:1;"><div style="display:flex; align-items:center; gap:8px; margin-bottom:4px;"><span style="background:#e3f2fd; color:#0a73c0; font-size:9px; font-weight:800; padding:2px 6px; border-radius:4px;">${rowType}</span><span style="font-size:10px; color:#999;">${rowDate}</span></div><div class="list-title">${rowMsg}</div></div></div>`;
                if(rowLink && rowLink.length > 5) {
                    foundRep = true;
                    repHtml += `<div class="list-item"><div><div class="list-title">üìÑ ${rowType} Report</div><div class="list-date">${rowDate}</div></div><a href="${rowLink}" target="_blank" class="action-icon icon-green">‚¨á Download</a></div>`;
                }
            }
        });
        histCon.innerHTML = foundHist ? histHtml : '<div style="text-align:center;padding:10px;color:#999;">No bookings found.</div>';
        repCon.innerHTML = foundRep ? repHtml : '<div style="text-align:center;padding:10px;color:#999;">No reports available yet.</div>';
    } catch(e) {
        histCon.innerHTML = '<div style="text-align:center;padding:10px;color:red;">Error loading history.</div>';
        repCon.innerHTML = '<div style="text-align:center;padding:10px;color:red;">Error loading reports.</div>';
    }
}
</script>
</body>
</html>
